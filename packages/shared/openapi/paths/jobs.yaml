# ==============================================================================
# JOB ENDPOINTS
# Async job polling
# ==============================================================================

# ------------------------------------------------------------------------------
# POLL JOB STATUS
# ------------------------------------------------------------------------------

/j/{key}:
  get:
    operationId: pollJobStatus
    tags:
      - Jobs
    summary: Poll async job status
    security:
      - capabilityKeyAuth: []
    description: |
      Poll the status of an asynchronous job. Job poll URLs use capability keys
      (same format as file keys) to prevent job ID guessing.

      Jobs complete within 60 seconds or fail.

      **Job lifecycle:**
      - `pending`: Job is queued, waiting to start
      - `processing`: Job is currently running
      - `completed`: Job finished successfully, result available
      - `failed`: Job encountered an error

      Job poll URLs expire after the job completes + 1 hour.
    parameters:
      - name: key
        in: path
        required: true
        description: Job capability key (same format as file keys)
        schema:
          type: string
          pattern: '^[A-Za-z0-9_]{20,}$'
          minLength: 20
    responses:
      '200':
        description: Job status retrieved successfully
        content:
          application/json:
            schema:
              $ref: '../components/schemas.yaml#/JobResponse'
            examples:
              pending:
                summary: Job pending
                value:
                  ok: true
                  data:
                    id: job_xyz
                    status: pending
                    createdAt: "2024-01-08T10:30:00Z"
              processing:
                summary: Job processing
                value:
                  ok: true
                  data:
                    id: job_xyz
                    status: processing
                    progress:
                      current: 15
                      total: 50
                      message: Processing files...
                    createdAt: "2024-01-08T10:30:00Z"
              completed:
                summary: Job completed
                value:
                  ok: true
                  data:
                    id: job_xyz
                    status: completed
                    result:
                      created:
                        - { filename: "README.md", id: "x1" }
                        - { filename: "TODO.md", id: "x2" }
                    createdAt: "2024-01-08T10:30:00Z"
                    completedAt: "2024-01-08T10:31:00Z"
              failed:
                summary: Job failed
                value:
                  ok: true
                  data:
                    id: job_xyz
                    status: failed
                    error:
                      code: PARTIAL_FAILURE
                      message: 3 files failed to create
                    createdAt: "2024-01-08T10:30:00Z"
                    completedAt: "2024-01-08T10:31:00Z"
      '404':
        description: Job not found or expired
        content:
          application/json:
            schema:
              $ref: '../components/schemas.yaml#/Error'
            example:
              ok: false
              error:
                code: JOB_NOT_FOUND
                message: Job not found or expired
      '429':
        $ref: '../components/responses.yaml#/RateLimited'

