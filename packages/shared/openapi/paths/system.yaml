# ==============================================================================
# SYSTEM ENDPOINTS
# Health, status, documentation, and capability checking
# ==============================================================================

/health:
  get:
    operationId: healthCheck
    tags:
      - System
    summary: Health check (liveness probe)
    security: []
    description: |
      Simple health check endpoint for load balancer probes, Docker HEALTHCHECK,
      and Kubernetes liveness/readiness.

      Returns a simple response indicating the service is alive.
      For comprehensive system status with subsystem checks, use `/api/v1/status`.

      No authentication required.
    responses:
      '200':
        description: Service is healthy
        content:
          application/json:
            schema:
              $ref: '../components/schemas/system.yaml#/HealthCheckSimpleResponse'
            example:
              ok: true
              status: healthy
              timestamp: "2024-01-08T10:30:00Z"
              uptimeSeconds: 3600
              version: "0.1.0"
      '429':
        $ref: '../components/responses.yaml#/RateLimited'

/openapi.json:
  get:
    operationId: getOpenApiSpec
    tags:
      - System
    summary: OpenAPI specification
    security: []
    description: |
      Returns the OpenAPI 3.1 specification for the API in JSON format.

      Auto-generated by Elysia from route definitions.

      No authentication required.
    responses:
      '200':
        description: OpenAPI specification
        content:
          application/json:
            schema:
              type: object
              description: OpenAPI 3.1 specification document
      '429':
        $ref: '../components/responses.yaml#/RateLimited'

/docs:
  get:
    operationId: getApiDocs
    tags:
      - System
    summary: API documentation
    security: []
    description: |
      Interactive API documentation (Swagger UI or similar).

      Uses Elysia's `@elysiajs/swagger` plugin.

      No authentication required.
    responses:
      '200':
        description: API documentation page
        content:
          text/html:
            schema:
              type: string
              description: HTML page with interactive API documentation
      '429':
        $ref: '../components/responses.yaml#/RateLimited'

/api/v1/changelog:
  get:
    operationId: getChangelog
    tags:
      - System
    summary: API changelog
    security: []
    description: |
      Returns the API changelog with version history, release dates, and changes.

      Useful for tracking API updates and planning migrations.

      No authentication required.
    responses:
      '200':
        description: API changelog
        content:
          application/json:
            schema:
              $ref: '../components/schemas/system.yaml#/ChangelogResponse'
            example:
              ok: true
              data:
                currentVersion: "1.5.2"
                releasedAt: "2025-12-15T00:00:00Z"
                entries:
                  - version: "1.5.2"
                    date: "2025-12-15"
                    changes:
                      - type: added
                        description: "Added bulk append endpoint"
                      - type: fixed
                        description: "Fixed race condition in claim renewal"
      '429':
        $ref: '../components/responses.yaml#/RateLimited'


/api/v1/status:
  get:
    operationId: getServiceStatus
    tags:
      - System
    summary: Service status (comprehensive)
    security: []
    description: |
      Returns the current service status for all components.

      Useful for programmatic status checks (e.g., agents deciding whether to retry)
      and status page integration.

      For simple liveness probes, use `/health` instead.

      No authentication required.
    responses:
      '200':
        description: Service status
        content:
          application/json:
            schema:
              $ref: '../components/schemas/system.yaml#/StatusResponse'
            example:
              ok: true
              data:
                status: operational
                timestamp: "2026-02-22T19:01:10.304Z"
                environment: production
                uptimeSeconds: 86400
                version: "0.1.0"
                database:
                  status: operational
                  latencyMs: 15
                storage:
                  status: operational
                  latencyMs: 8
                websocket:
                  status: operational
                  latencyMs: 31
                  activeConnections: 42
                regions:
                  - name: "us-east-1"
                    status: operational
      '429':
        $ref: '../components/responses.yaml#/RateLimited'

/capabilities/check:
  post:
    operationId: checkCapabilities
    tags:
      - System
    summary: Check capabilities for URLs
    security: []
    description: |
      Check the validity of capability URLs without accessing the underlying resources.

      Useful for agents and systems with multiple capability URLs to verify their validity.

      Returns minimal information about each URL's validity and permission level.

      No authentication required.

      **Rate limiting:** 5 requests/min per IP.
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../components/schemas/keys.yaml#/CapabilitiesCheckRequest'
          example:
            keys:
              - "x8k2mP9qL3nR"
              - "3kL9mQ2pN7xR"
              - "invalidKey123"
    responses:
      '200':
        description: Capability check results
        content:
          application/json:
            schema:
              $ref: '../components/schemas/keys.yaml#/CapabilitiesCheckResponse'
            example:
              ok: true
              data:
                results:
                  - key: "x8k2mP9q..."
                    valid: true
                    permission: read
                    scope: file
                  - key: "3kL9mQ2p..."
                    valid: true
                    permission: append
                    scope: folder
                  - key: "invalidK..."
                    valid: false
                    error: NOT_FOUND
      '400':
        $ref: '../components/responses.yaml#/BadRequest'
      '429':
        $ref: '../components/responses.yaml#/RateLimited'


/w/{key}/capabilities/check:
  post:
    operationId: checkCapabilitiesInWorkspace
    tags:
      - System
    summary: Check capabilities for URLs in workspace context
    security:
      - capabilityKeyAuth: []
    description: |
      Check the validity of capability URLs with extended information available
      when using a write key.

      Returns extended information about keys belonging to the file/workspace,
      including path and detailed status.

      Keys for other files return minimal response (valid/invalid only).

      **Use cases:**
      - Agent startup: "Which of my configured keys are still valid?"
      - Monitoring: "Have any of our capability URLs been rotated?"
      - File owner audit: "What keys exist for my file and what permissions do they have?"

      **Rate limiting:** 5 requests/min per IP.
    parameters:
      - $ref: '../components/parameters.yaml#/capabilityKey'
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../components/schemas/keys.yaml#/CapabilitiesCheckRequest'
          example:
            keys:
              - "x8k2mP9qL3nR"
              - "3kL9mQ2pN7xR"
              - "invalidKey123"
    responses:
      '200':
        description: Capability check results with extended information
        content:
          application/json:
            schema:
              $ref: '../components/schemas/keys.yaml#/CapabilitiesCheckInWorkspaceResponse'
            example:
              ok: true
              data:
                results:
                  - key: "x8k2mP9q..."
                    valid: true
                    permission: read
                    scope: file
                    path: "/projects/alpha/tasks.md"
                    status: active
                  - key: "3kL9mQ2p..."
                    valid: true
                    permission: append
                    scope: file
                    path: "/projects/alpha/tasks.md"
                    status: active
                  - key: "invalidK..."
                    valid: false
                    error: NOT_FOUND
      '400':
        $ref: '../components/responses.yaml#/BadRequest'
      '404':
        $ref: '../components/responses.yaml#/NotFound'
      '429':
        $ref: '../components/responses.yaml#/RateLimited'
