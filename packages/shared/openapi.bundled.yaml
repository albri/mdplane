openapi: 3.1.0
info:
  title: mdplane API
  version: 1.0.0
  description: |
    Markdown-based coordination layer for AI agents.

    ## Authentication

    Most endpoints use capability URLs - the secret is in the URL path.
    No authentication headers required for `/r/`, `/a/`, `/w/` endpoints.

    Account controls endpoints (`/auth/*`, `/workspaces/*`) use session cookies.

    ## Capability URL Tiers

    | URL Pattern | Permission | Can Do |
    |-------------|------------|--------|
    | `/r/:key` | Read | GET file, structure, metadata, appends, search, stats |
    | `/a/:key` | Append | Everything in Read + POST appends, heartbeats |
    | `/w/:key` | Write | Everything in Append + PUT, DELETE, webhooks, keys |

    ## Key Formats

    | Key Type | Pattern | Example |
    |----------|---------|---------|
    | Root capability key | `^[A-Za-z0-9]{22,}$` | `x8k2mP9qL3nR7mQ2pN4xK9` |
    | Scoped capability key | `^(r\|a\|w)_[A-Za-z0-9]{20,}$` | `a_x8k2mP9qL3nR7mQ2pN4x` |
    | API key (live) | `^sk_live_[A-Za-z0-9]{20,}$` | `sk_live_x8k2mP9qL3nR...` |
    | API key (test) | `^sk_test_[A-Za-z0-9]{20,}$` | `sk_test_y9m3nP0rL4oS...` |
  contact:
    name: mdplane Team
    url: https://mdplane.dev
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
servers:
  - url: https://api.mdplane.dev
    description: Production
  - url: http://localhost:3000
    description: Local development
tags:
  - name: Bootstrap
    description: Create new workspaces (no auth required)
  - name: Files
    description: File operations via capability URLs
  - name: Appends
    description: Append content to files
  - name: Folders
    description: Folder operations
  - name: Keys
    description: Scoped capability key management
  - name: Auth
    description: OAuth authentication via BetterAuth (GitHub/Google)
  - name: Claiming
    description: Workspace claiming and recovery
  - name: Workspaces
    description: Workspace management (OAuth required)
  - name: API Keys
    description: API key management for claimed workspaces
  - name: Webhooks
    description: Webhook configuration
  - name: Search
    description: Full-text search
  - name: Real-time
    description: WebSocket subscription and heartbeat
  - name: Stats
    description: File and workspace statistics
  - name: Jobs
    description: Background job management
  - name: Export
    description: Data export functionality
  - name: Agents
    description: Agent management
  - name: Orchestration
    description: Multi-agent orchestration
  - name: System
    description: System health and status
  - name: Admin
    description: Operator-only endpoints (requires ADMIN_SECRET)
paths:
  /bootstrap:
    post:
      operationId: createWorkspace
      tags:
        - Bootstrap
      summary: Create a new workspace
      security: []
      description: |
        Zero-friction entry point. Creates a new workspace with a root folder immediately.

        No authentication required. Users can start creating files right away using the 
        returned capability URLs.

        **Rate limit:** 10 workspaces per IP per hour.
      requestBody:
        required: true
        description: Required workspace bootstrap configuration
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BootstrapRequest'
            examples:
              withName:
                summary: Create with workspace name
                value:
                  workspaceName: My Project
      responses:
        '201':
          description: Workspace created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BootstrapResponse'
              example:
                ok: true
                data:
                  workspaceId: ws_x8k2mP9qL3nR
                  keys:
                    read: m7dXp9lKa2nQe4R8vL5wYt
                    append: a_nK3pL9mQ2xR8vL5wYt
                    write: w_vT5yU8wX1zA4vL5wYt
                  urls:
                    api:
                      read: https://api.mdplane.dev/r/m7dXp9lKa2nQe4R8vL5wYt
                      append: https://api.mdplane.dev/a/a_nK3pL9mQ2xR8vL5wYt
                      write: https://api.mdplane.dev/w/w_vT5yU8wX1zA4vL5wYt
                    web:
                      read: https://app.mdplane.dev/r/m7dXp9lKa2nQe4R8vL5wYt
                      claim: https://app.mdplane.dev/claim/w_vT5yU8wX1zA4vL5wYt
                  createdAt: '2024-01-08T09:00:00Z'
        '400':
          $ref: '#/components/responses/BadRequest'
        '429':
          description: Rate limit exceeded
          headers:
            Retry-After:
              description: Seconds to wait before retrying
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                ok: false
                error:
                  code: RATE_LIMITED
                  message: Too many workspace creation requests. Please try again later.
                  details:
                    retryAfterSeconds: 3600
  /r/{key}:
    get:
      operationId: readFile
      tags:
        - Files
      summary: Read file content
      security:
        - capabilityKeyAuth: []
      description: |
        Read file content with optional format and filtering options.

        Supports multiple response formats via the `format` query parameter:
        - `raw`: Plain markdown content (use /r/{key}/raw endpoint for text/markdown response)
        - `parsed`: Structured parse with frontmatter, sections, and appends array
        - `structure`: File headings and metadata only

        Use `since` parameter to get only appends after a sequence number (for WebSocket reconnection catch-up).
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/format'
        - $ref: '#/components/parameters/since'
        - name: appends
          in: query
          description: Number of recent appends to include
          schema:
            type: integer
            minimum: 0
            maximum: 1000
        - name: include
          in: query
          description: Include additional data (e.g., stats)
          schema:
            type: string
            enum:
              - stats
      responses:
        '200':
          description: File content retrieved successfully
          headers:
            ETag:
              description: Content version hash for optimistic concurrency
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileReadResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /w/{key}:
    get:
      operationId: readFileViaWriteKey
      tags:
        - Files
      summary: Read file content (write key)
      security:
        - capabilityKeyAuth: []
      description: |
        Read file content using a write key. Write keys inherit all read capabilities.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/format'
        - $ref: '#/components/parameters/since'
        - name: appends
          in: query
          description: Number of recent appends to include
          schema:
            type: integer
            minimum: 0
            maximum: 1000
        - name: include
          in: query
          description: Include additional data (e.g., stats)
          schema:
            type: string
            enum:
              - stats
      responses:
        '200':
          description: File content retrieved successfully
          headers:
            ETag:
              description: Content version hash for optimistic concurrency
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileReadResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
    put:
      operationId: updateFile
      tags:
        - Files
      summary: Update file content
      security:
        - capabilityKeyAuth: []
      description: |
        Replace entire file content. Requires write key.

        Use `If-Match` header with ETag for optimistic concurrency control.
        If omitted, last-write-wins.

        Existing appends are marked stale after content replacement.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - name: If-Match
          in: header
          description: ETag from previous read for optimistic concurrency
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FileUpdateRequest'
      responses:
        '200':
          description: File updated successfully
          headers:
            ETag:
              description: New content version hash
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileUpdateResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '410':
          $ref: '#/components/responses/Gone'
        '412':
          description: ETag mismatch - file was modified since last read
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimited'
    delete:
      operationId: deleteFile
      tags:
        - Files
      summary: Delete file
      security:
        - capabilityKeyAuth: []
      description: |
        Delete a file. Soft delete by default (recoverable for 7 days).

        Use `?permanent=true` for hard delete (irreversible).
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - name: permanent
          in: query
          description: Hard delete (irreversible)
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: File deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileDeleteResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
    patch:
      operationId: renameFile
      tags:
        - Files
      summary: Rename file
      security:
        - capabilityKeyAuth: []
      description: |
        Rename a file. Capability URLs remain unchanged.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FileRenameRequest'
      responses:
        '200':
          description: File renamed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileRenameResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /r/{key}/raw:
    get:
      operationId: readFileRaw
      tags:
        - Files
      summary: Read raw file content
      security:
        - capabilityKeyAuth: []
      description: |
        Returns raw markdown content with `Content-Type: text/markdown`. No JSON envelope.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      responses:
        '200':
          description: Raw markdown content
          headers:
            ETag:
              description: Content version hash
              schema:
                type: string
          content:
            text/markdown:
              schema:
                type: string
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /r/{key}/meta:
    get:
      operationId: readFileMeta
      tags:
        - Files
      summary: Read file metadata
      security:
        - capabilityKeyAuth: []
      description: |
        Get file metadata without content. Includes filename, folder, size, timestamps,
        append count, task stats, and webhook status.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      responses:
        '200':
          description: File metadata retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileMetaResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /r/{key}/tail:
    get:
      operationId: readFileTail
      tags:
        - Files
      summary: Read last N appends
      security:
        - capabilityKeyAuth: []
      description: |
        Get the last N bytes or lines of file content. Efficient for tailing large files.

        **Performance note:** Byte-based tail is O(1) via file seek. Line-based requires
        reading from end until N newlines found. For files >1MB, prefer `?bytes=`.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - name: bytes
          in: query
          description: Last N bytes to return (default 10000, max 100000)
          schema:
            type: integer
            default: 10000
            maximum: 100000
        - name: lines
          in: query
          description: Last N lines to return (approximate)
          schema:
            type: integer
            maximum: 1000
      responses:
        '200':
          description: Tail content retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileTailResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /r/{key}/structure:
    get:
      operationId: readFileStructure
      tags:
        - Files
      summary: Read file structure/headings
      security:
        - capabilityKeyAuth: []
      description: |
        Get document structure including headings (level, text, line number),
        append count, and whether file has task appends.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      responses:
        '200':
          description: File structure retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileStructureResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /r/{key}/section/{heading}:
    get:
      operationId: readFileSection
      tags:
        - Files
      summary: Read specific section by heading
      security:
        - capabilityKeyAuth: []
      description: |
        Get content of a specific section identified by its heading text.
        Returns the section content along with start and end line numbers.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - name: heading
          in: path
          required: true
          description: Heading text to find (URL-encoded)
          schema:
            type: string
      responses:
        '200':
          description: Section content retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileSectionResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /r/{key}/ops/file/append/{appendId}:
    get:
      operationId: readAppend
      tags:
        - Files
      summary: Read specific append
      security:
        - capabilityKeyAuth: []
      description: |
        Get a specific append by ID. Returns the full append object including
        author, timestamp, type, content, and any references.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/appendId'
      responses:
        '200':
          description: Append retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppendGetResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /w/{key}/recover:
    post:
      operationId: recoverFile
      tags:
        - Files
      summary: Recover deleted file
      security:
        - capabilityKeyAuth: []
      description: |
        Recover a soft-deleted file within the 7-day recovery window.

        Use `?rotateUrls=true` to generate new capability URLs (invalidates old ones).
        Useful when recovering after a URL leak.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - name: rotateUrls
          in: query
          description: Generate new capability URLs (invalidates old ones)
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: File recovered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileRecoverResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
  /w/{key}/move:
    post:
      operationId: moveFile
      tags:
        - Files
      summary: Move file to new folder
      security:
        - capabilityKeyAuth: []
      description: |
        Move a file to a different folder. Capability URLs remain unchanged.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FileMoveRequest'
      responses:
        '200':
          description: File moved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileMoveResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /w/{key}/rotate:
    post:
      operationId: rotateCapabilityUrls
      tags:
        - Files
      summary: Rotate capability URLs
      security:
        - capabilityKeyAuth: []
      description: |
        Generate new capability URLs for the file. Old URLs become invalid immediately.

        Use this to revoke access for anyone who has the current URLs.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      responses:
        '200':
          description: URLs rotated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileRotateUrlsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /w/{key}/settings:
    get:
      operationId: getFileSettings
      tags:
        - Files
      summary: Get file settings
      security:
        - capabilityKeyAuth: []
      description: |
        Get file-specific settings including claim duration, max append size,
        allowed append types, WIP limit, and labels.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      responses:
        '200':
          description: File settings retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileSettingsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
    patch:
      operationId: updateFileSettings
      tags:
        - Files
      summary: Update file settings
      security:
        - capabilityKeyAuth: []
      description: |
        Partially update file settings. Only provided fields are updated.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FileSettingsUpdateRequest'
      responses:
        '200':
          description: File settings updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileSettingsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /a/{key}/append:
    post:
      operationId: createAppend
      tags:
        - Appends
      summary: Create append
      security:
        - capabilityKeyAuth: []
      description: |
        Append content to a file. Supports two modes:

        **Single append:** Provide `type`, `content`, and optional fields directly.

        **Atomic multi-append:** Provide `appends` array for operations that must succeed
        or fail together (e.g., complete task + create follow-up). If any append fails
        validation, all are rejected.

        The `appends` array and single-append fields are mutually exclusive.

        Key scope behavior:
        - **File-scoped key:** file path is derived from the key scope; `path` in body is optional.
        - **Workspace/folder-scoped key:** `path` in body is required.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/AppendRequest'
                - $ref: '#/components/schemas/MultiAppendRequest'
            examples:
              singleAppend:
                summary: Single append
                value:
                  author: jordan
                  type: task
                  content: Review PR
                  priority: high
                  labels:
                    - bug
                    - backend
              atomicMultiAppend:
                summary: Atomic multi-append
                value:
                  author: jordan
                  appends:
                    - type: response
                      ref: a1
                      content: Done - fixed the bug
                    - type: task
                      content: 'Follow-up: deploy fix to production'
                      priority: high
              workspaceScopedAppend:
                summary: Workspace-scoped append with explicit path
                value:
                  path: tasks/backlog.md
                  author: jordan
                  type: task
                  content: Triage production alerts
      responses:
        '201':
          description: Append created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppendResponse'
              examples:
                singleResult:
                  summary: Single append result
                  value:
                    ok: true
                    serverTime: '2024-01-08T10:30:00Z'
                    data:
                      id: a5
                      author: jordan
                      ts: '2024-01-08T10:30:00Z'
                      type: task
                multiResult:
                  summary: Multi-append result
                  value:
                    ok: true
                    serverTime: '2024-01-08T10:30:00Z'
                    data:
                      appends:
                        - id: a6
                          type: response
                          ref: a1
                        - id: a7
                          type: task
        '400':
          description: |
            Invalid request. Possible error codes:
            - `INVALID_APPEND_TYPE`: Unknown type value
            - `INVALID_REF`: ref points to wrong append type or doesn't exist
            - `INVALID_VOTE_VALUE`: vote type with value other than +1 or -1
            - `INVALID_AUTHOR`: Author field fails validation
            - `TASK_ALREADY_COMPLETE`: Trying to claim a completed task
            - `TASK_CANCELLED`: Trying to claim, respond to, or renew a cancelled task
            - `CLAIM_EXPIRED`: Trying to renew, respond to, or mark blocked a claim that has expired
            - `AUTHOR_MISMATCH`: Append author doesn't match key's boundAuthor
            - `TYPE_NOT_ALLOWED`: Append type not in key's allowedTypes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: |
            Conflict. Possible error codes:
            - `ALREADY_CLAIMED`: Task already has active claim
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          description: |
            Rate limited. Possible error codes:
            - `RATE_LIMITED`: Too many requests
            - `WIP_LIMIT_EXCEEDED`: Author at max concurrent claims
            - `AUTHOR_RATE_LIMITED`: Author exceeded per-file or per-workspace append limit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /a/{key}/{path}:
    post:
      operationId: createScopedAppend
      tags:
        - Appends
      summary: Create scoped append
      security:
        - capabilityKeyAuth: []
      description: |
        Append content to a file at a specific path using a scoped capability key.

        This endpoint is used with scoped keys that have restrictions like:
        - `scopePath`: Key can only access files within a specific path prefix
        - `boundAuthor`: Key can only create appends with a specific author
        - `allowedTypes`: Key can only create appends of specific types

        The file path is specified in the URL, and the append is created with the
        provided author, type, and content.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - name: path
          in: path
          required: true
          description: Path to the file within the workspace (relative to scopePath if set)
          schema:
            type: string
          example: tasks/backlog.md
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScopedAppendRequest'
            examples:
              simpleAppend:
                summary: Simple append with author and content
                value:
                  author: agent-01
                  type: comment
                  content: Processing complete
      responses:
        '201':
          description: Append created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScopedAppendResponse'
              example:
                ok: true
                data:
                  appendId: a1704700200000
                  type: comment
                  author: agent-01
                  createdAt: '2024-01-08T10:30:00Z'
        '400':
          description: |
            Invalid request. Possible error codes:
            - `AUTHOR_MISMATCH`: Author does not match key's boundAuthor
            - `TYPE_NOT_ALLOWED`: Append type not in key's allowedTypes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: |
            Not found. Possible error codes:
            - `KEY_NOT_FOUND`: Invalid capability key
            - `FILE_NOT_FOUND`: File does not exist at the specified path
            - `PERMISSION_DENIED`: Path outside of key's scopePath
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /r/{key}/folders/{path}:
    get:
      operationId: listFolderContents
      tags:
        - Folders
      summary: List folder contents
      security:
        - capabilityKeyAuth: []
      description: |
        List contents of a folder including files and subfolders.

        Supports pagination and sorting.

        **Permission inheritance:** Returned file URLs respect the folder's permission level:
        - Folder read key → returns file read URLs only
        - Folder append key → returns file append URLs
        - Folder write key → returns file write URLs

        **Export mode:** Use `?action=export` to download folder contents as an archive.
        Same query params as workspace export, but scoped to this folder.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPath'
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/cursor'
        - name: action
          in: query
          description: |
            Special action to perform. When set to `export`, returns folder contents as
            a downloadable archive instead of JSON listing.
          schema:
            type: string
            enum:
              - export
        - name: format
          in: query
          description: Archive format (only used when action=export)
          schema:
            type: string
            enum:
              - zip
              - tar.gz
            default: zip
        - name: recursive
          in: query
          description: Include all nested contents recursively
          schema:
            type: boolean
            default: false
        - name: sort
          in: query
          description: Sort field
          schema:
            type: string
            enum:
              - name
              - modified
              - size
            default: name
        - name: order
          in: query
          description: Sort order
          schema:
            type: string
            enum:
              - asc
              - desc
            default: asc
        - name: includeAppends
          in: query
          description: Include append history in export metadata (only used when action=export)
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: |
            Folder contents retrieved successfully.

            When `action=export`, returns binary archive with Content-Disposition header.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderListResponse'
            application/zip:
              schema:
                type: string
                format: binary
            application/gzip:
              schema:
                type: string
                format: binary
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
  /a/{key}/folders/{path}:
    get:
      operationId: listFolderContentsViaAppendKey
      tags:
        - Folders
      summary: List folder contents (append key)
      security:
        - capabilityKeyAuth: []
      description: |
        List folder contents using an append key. Append keys inherit all read capabilities.
        Returns file append URLs in response.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPath'
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/cursor'
        - name: recursive
          in: query
          description: Include all nested contents recursively
          schema:
            type: boolean
            default: false
        - name: sort
          in: query
          description: Sort field
          schema:
            type: string
            enum:
              - name
              - modified
              - size
            default: name
        - name: order
          in: query
          description: Sort order
          schema:
            type: string
            enum:
              - asc
              - desc
            default: asc
      responses:
        '200':
          description: Folder contents retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderListResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
  /a/{key}/folders/{path}/files:
    post:
      operationId: createFileInFolder
      tags:
        - Folders
      summary: Create file in folder
      security:
        - capabilityKeyAuth: []
      description: |
        Create a new file in the specified folder. Uses folder append key.

        Creating files is a safe additive operation. The creator receives all 3 file URLs
        regardless of which folder key they used.

        **Atomic creation:** If two clients attempt to create a file with the same name
        simultaneously, exactly one succeeds (409 FILE_ALREADY_EXISTS for the other).

        Use `Idempotency-Key` header to safely retry file creation.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateFileRequest'
      responses:
        '201':
          description: File created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateFileResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '429':
          $ref: '#/components/responses/RateLimited'
  /w/{key}/folders/{path}:
    get:
      operationId: listFolderContentsViaWriteKey
      tags:
        - Folders
      summary: List folder contents (write key)
      security:
        - capabilityKeyAuth: []
      description: |
        List folder contents using a write key. Write keys inherit all read capabilities.
        Returns file write URLs in response.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPath'
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/cursor'
        - name: recursive
          in: query
          description: Include all nested contents recursively
          schema:
            type: boolean
            default: false
        - name: sort
          in: query
          description: Sort field
          schema:
            type: string
            enum:
              - name
              - modified
              - size
            default: name
        - name: order
          in: query
          description: Sort order
          schema:
            type: string
            enum:
              - asc
              - desc
            default: asc
      responses:
        '200':
          description: Folder contents retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderListResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
    patch:
      operationId: renameFolder
      tags:
        - Folders
      summary: Rename folder
      security:
        - capabilityKeyAuth: []
      description: |
        Rename a folder. Capability URLs remain unchanged.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FolderRenameRequest'
      responses:
        '200':
          description: Folder renamed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderMoveResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '429':
          $ref: '#/components/responses/RateLimited'
    delete:
      operationId: deleteFolder
      tags:
        - Folders
      summary: Delete folder
      security:
        - capabilityKeyAuth: []
      description: |
        Delete a folder. Empty folders are deleted directly.

        For non-empty folders, use cascade delete with confirmation:
        - Set `cascade: true` in request body
        - Set `confirmPath` to match the folder path exactly (without leading slash)

        Cascade delete is **soft delete only** — all files remain recoverable for 7 days.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPath'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FolderDeleteRequest'
      responses:
        '200':
          description: Folder deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderDeleteResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Folder not empty (use cascade delete)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimited'
  /w/{key}/folders:
    post:
      operationId: createFolder
      tags:
        - Folders
      summary: Create new folder
      security:
        - capabilityKeyAuth: []
      description: |
        Create a new folder within the workspace or parent folder.

        Returns capability URLs for the new folder.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FolderCreateRequest'
      responses:
        '201':
          description: Folder created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderCreateResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          $ref: '#/components/responses/Conflict'
        '429':
          $ref: '#/components/responses/RateLimited'
  /a/{key}/folders/{path}/copy:
    post:
      operationId: copyFileToFolder
      tags:
        - Folders
      summary: Copy file to folder
      security:
        - capabilityKeyAuth: []
      description: |
        Copy a file from another location into this folder.

        Requires a source file key (read access to source file).
        Optionally specify a new filename.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CopyFileToFolderRequest'
      responses:
        '201':
          description: File copied successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateFileResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '429':
          $ref: '#/components/responses/RateLimited'
  /a/{key}/folders/{path}/bulk:
    post:
      operationId: bulkCreateFiles
      tags:
        - Folders
      summary: Bulk create files in folder
      security:
        - capabilityKeyAuth: []
      description: |
        Create multiple files in a folder in a single request.

        **Async mode:** Use `?async=true` to return immediately with a job ID.
        Poll the job status endpoint to check completion.

        **Limits:** Maximum 100 files per request.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPath'
        - name: async
          in: query
          description: Return immediately with job ID for async processing
          schema:
            type: boolean
            default: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FolderBulkCreateRequest'
      responses:
        '201':
          description: Files created successfully (sync mode)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderBulkCreateResponse'
        '202':
          description: Job accepted (async mode)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderBulkCreateJobResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
  /w/{key}/folders/{path}/move:
    post:
      operationId: moveFolder
      tags:
        - Folders
      summary: Move folder to new location
      security:
        - capabilityKeyAuth: []
      description: |
        Move a folder to a new destination path.

        Capability URLs remain unchanged after move.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FolderMoveRequest'
      responses:
        '200':
          description: Folder moved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderMoveResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '429':
          $ref: '#/components/responses/RateLimited'
  /w/{key}/folders/{path}/settings:
    get:
      operationId: getFolderSettings
      tags:
        - Folders
      summary: Get folder settings
      security:
        - capabilityKeyAuth: []
      description: |
        Get settings for a folder including WIP limits, claim duration,
        and other coordination settings.

        Settings are inherited by files in the folder unless overridden.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPath'
      responses:
        '200':
          description: Folder settings retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderSettingsResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
    patch:
      operationId: updateFolderSettings
      tags:
        - Folders
      summary: Update folder settings
      security:
        - capabilityKeyAuth: []
      description: |
        Update settings for a folder. Only provided fields are updated.

        **Inheritance:** Files inherit folder settings. File-level settings
        override folder settings.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FolderSettingsUpdateRequest'
      responses:
        '200':
          description: Folder settings updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderSettingsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
  /r/{key}/ops/folders/stats:
    get:
      operationId: getFolderStats
      tags:
        - Folders
      summary: Get folder statistics
      security:
        - capabilityKeyAuth: []
      description: |
        Get aggregate statistics for a folder including file count, folder count,
        total size, last modified timestamp, and task statistics.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPathQuery'
      responses:
        '200':
          description: Folder statistics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderStatsResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
  /r/{key}/ops/folders/search:
    get:
      operationId: searchInFolder
      tags:
        - Folders
      summary: Search within folder
      security:
        - capabilityKeyAuth: []
      description: |
        Full-text search within a folder and its contents.

        Supports filtering by labels, priority, status, and author.

        **Performance note:** If search hits timeout, returns partial results with
        `truncated: true`. Increase `limit` or add filters to reduce search scope.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPathQuery'
        - name: q
          in: query
          description: Full-text search query
          schema:
            type: string
            maxLength: 500
        - name: type
          in: query
          description: Filter by append type
          schema:
            type: string
            enum:
              - task
              - comment
              - response
              - claim
        - name: status
          in: query
          description: Filter by task status (comma-separated for multiple)
          schema:
            type: string
            enum:
              - pending
              - claimed
              - completed
              - failed
        - $ref: '#/components/parameters/author'
        - name: labels
          in: query
          description: Filter by labels (comma-separated, OR matching)
          schema:
            type: string
        - name: priority
          in: query
          description: Filter by priority (comma-separated for multiple)
          schema:
            type: string
        - name: since
          in: query
          description: Modified after this date (ISO 8601)
          schema:
            type: string
            format: date-time
        - name: timeout
          in: query
          description: Max search duration (default 5s, max 30s)
          schema:
            type: string
            default: 5s
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/cursor'
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderSearchResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
  /r/{key}/ops/folders/tasks:
    get:
      operationId: queryFolderTasks
      tags:
        - Folders
      summary: Query tasks across folder
      security:
        - capabilityKeyAuth: []
      description: |
        Aggregate tasks across all files in a folder. Returns tasks with their
        file context and current status.

        Useful for account controls views and orchestration views.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPathQuery'
        - name: status
          in: query
          description: Filter by task status (comma-separated for multiple)
          schema:
            type: string
            enum:
              - pending
              - claimed
              - completed
              - cancelled
        - $ref: '#/components/parameters/author'
        - name: priority
          in: query
          description: Filter by priority (comma-separated for multiple)
          schema:
            type: string
        - name: labels
          in: query
          description: Filter by labels (comma-separated, OR matching)
          schema:
            type: string
        - name: claimedBy
          in: query
          description: Filter by claiming agent identifier
          schema:
            type: string
        - name: claimable
          in: query
          description: Only return unclaimed tasks when true
          schema:
            type: boolean
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/cursor'
      responses:
        '200':
          description: Tasks retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskQueryResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
  /r/{key}/ops/folders/subscribe:
    get:
      operationId: subscribeFolderEvents
      tags:
        - Folders
      summary: Subscribe to folder events (WebSocket)
      security:
        - capabilityKeyAuth: []
      description: |
        WebSocket endpoint for real-time folder events.

        **Connection:** Upgrade to WebSocket protocol.

        **Events received:**
        - `file_created` - New file created in folder
        - `file_deleted` - File deleted from folder
        - `file_moved` - File moved into/out of folder
        - `folder_created` - Subfolder created
        - `folder_deleted` - Subfolder deleted
        - `append` - New append on any file in folder (if subscribed)

        **Query parameters:**
        - `includeAppends=true` - Also receive append events for files
        - `recursive=true` - Include events from nested subfolders

        **Heartbeat:** Server sends ping every 30s. Client must respond with pong
        within 10s or connection is closed.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPathQuery'
        - name: includeAppends
          in: query
          description: Include append events for files in folder
          schema:
            type: boolean
            default: false
        - name: recursive
          in: query
          description: Include events from nested subfolders
          schema:
            type: boolean
            default: false
      responses:
        '101':
          description: WebSocket connection established (Switching Protocols)
        '200':
          description: WebSocket upgrade successful (for OpenAPI compliance)
          content:
            application/json:
              schema:
                type: object
                description: This endpoint upgrades to WebSocket. 200 is for OpenAPI compliance only.
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
  /a/{key}/ops/folders/subscribe:
    get:
      operationId: subscribeFolderEventsViaAppendKey
      tags:
        - Folders
      summary: Subscribe to folder events with append key (WebSocket)
      security:
        - capabilityKeyAuth: []
      description: |
        WebSocket endpoint for real-time folder events using an append key.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPathQuery'
        - name: includeAppends
          in: query
          description: Include append events for files in folder
          schema:
            type: boolean
            default: false
        - name: recursive
          in: query
          description: Include events from nested subfolders
          schema:
            type: boolean
            default: false
      responses:
        '101':
          description: WebSocket connection established (Switching Protocols)
        '200':
          description: WebSocket upgrade successful (for OpenAPI compliance)
          content:
            application/json:
              schema:
                type: object
                description: This endpoint upgrades to WebSocket. 200 is for OpenAPI compliance only.
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
  /w/{key}/ops/folders/subscribe:
    get:
      operationId: subscribeFolderEventsViaWriteKey
      tags:
        - Folders
      summary: Subscribe to folder events with write key (WebSocket)
      security:
        - capabilityKeyAuth: []
      description: |
        WebSocket endpoint for real-time folder events using a write key.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPathQuery'
        - name: includeAppends
          in: query
          description: Include append events for files in folder
          schema:
            type: boolean
            default: false
        - name: recursive
          in: query
          description: Include events from nested subfolders
          schema:
            type: boolean
            default: false
      responses:
        '101':
          description: WebSocket connection established (Switching Protocols)
        '200':
          description: WebSocket upgrade successful (for OpenAPI compliance)
          content:
            application/json:
              schema:
                type: object
                description: This endpoint upgrades to WebSocket. 200 is for OpenAPI compliance only.
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
  /w/{key}/folders/{path}/webhooks:
    post:
      operationId: createFolderWebhook
      tags:
        - Folders
      summary: Create folder webhook
      security:
        - capabilityKeyAuth: []
      description: |
        Register a webhook for folder events.

        **Events:**
        - `file_created` - New file created in folder
        - `file_deleted` - File deleted from folder
        - `file_moved` - File moved into/out of folder
        - `folder_created` - Subfolder created
        - `folder_deleted` - Subfolder deleted
        - `append` - New append on any file in folder

        **Limits:** Maximum 10 webhooks per folder.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookCreateRequest'
      responses:
        '201':
          description: Webhook created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookCreateResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          description: Webhook limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    get:
      operationId: listFolderWebhooks
      tags:
        - Folders
      summary: List folder webhooks
      security:
        - capabilityKeyAuth: []
      description: |
        List all webhooks registered for a folder.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPath'
      responses:
        '200':
          description: Webhooks retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookListResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
  /w/{key}/folders/{path}/webhooks/{webhookId}:
    delete:
      operationId: deleteFolderWebhook
      tags:
        - Folders
      summary: Delete folder webhook
      security:
        - capabilityKeyAuth: []
      description: |
        Delete a webhook registered for a folder.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPath'
        - name: webhookId
          in: path
          required: true
          schema:
            type: string
          description: Webhook ID to delete
      responses:
        '200':
          description: Webhook deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookDeleteResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
    patch:
      operationId: updateFolderWebhook
      tags:
        - Folders
      summary: Update folder webhook
      security:
        - capabilityKeyAuth: []
      description: |
        Update a webhook registered for a folder.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPath'
        - name: webhookId
          in: path
          required: true
          schema:
            type: string
          description: Webhook ID to update
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookUpdateRequest'
      responses:
        '200':
          description: Webhook updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookUpdateResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
  /a/{key}/folders/{path}/claims:
    get:
      operationId: listFolderClaims
      tags:
        - Folders
      summary: List claims in folder
      security:
        - capabilityKeyAuth: []
      description: |
        List active claims for an author across all files in a folder.

        Useful for agents to track their active work across multiple files.

        **Performance:** Claims are indexed by `(author, fileId)` for fast lookups.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/folderPath'
        - $ref: '#/components/parameters/author'
      responses:
        '200':
          description: Claims retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderClaimsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
  /w/{key}/keys:
    post:
      operationId: createScopedKey
      tags:
        - Keys
      summary: Create scoped key
      security:
        - capabilityKeyAuth: []
      description: |
        Create a scoped capability key with specific permissions and restrictions.

        Scoped keys can have:
        - **boundAuthor**: All appends must use this author name
        - **wipLimit**: Override WIP limit for this key
        - **allowedTypes**: Restrict which append types this key can create
        - **expiresAt**: Key expiration timestamp
        - **paths**: Restrict key to specific paths

        The response includes the full key (only shown once at creation).
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScopedKeyCreateRequest'
            example:
              permission: append
              boundAuthor: agent-alpha
              displayName: Alpha Research Agent
              wipLimit: 2
              allowedTypes:
                - claim
                - response
              expiresAt: '2024-02-01T00:00:00Z'
      responses:
        '201':
          description: Scoped key created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScopedKeyCreateResponse'
              example:
                ok: true
                data:
                  id: key_abc123def456
                  key: a_x8k2mP9qL3nR7mQ2pN4x
                  permission: append
                  boundAuthor: agent-alpha
                  displayName: Alpha Research Agent
                  wipLimit: 2
                  allowedTypes:
                    - claim
                    - response
                  expiresAt: '2024-02-01T00:00:00Z'
                  createdAt: '2024-01-10T10:00:00Z'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
    get:
      operationId: listScopedKeys
      tags:
        - Keys
      summary: List scoped keys
      security:
        - capabilityKeyAuth: []
      description: |
        List all scoped keys for a file. By default, revoked keys are excluded.

        Use `?includeRevoked=true` to include revoked keys in the response.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - name: includeRevoked
          in: query
          description: Include revoked keys in the response
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Scoped keys retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScopedKeyListResponse'
              example:
                ok: true
                data:
                  - id: key_1
                    key: a_x8k2...nR
                    permission: append
                    boundAuthor: agent-alpha
                    displayName: Alpha Research Agent
                    wipLimit: 2
                    createdAt: '2024-01-10T10:00:00Z'
                    lastUsedAt: '2024-01-10T11:30:00Z'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
  /w/{key}/keys/{keyId}:
    delete:
      operationId: revokeScopedKey
      tags:
        - Keys
      summary: Revoke scoped key
      security:
        - capabilityKeyAuth: []
      description: |
        Revoke a scoped key. The key becomes immediately unusable.

        Revoked keys remain in the list (with `revoked: true`) for audit purposes
        unless explicitly filtered out.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/keyId'
      responses:
        '200':
          description: Scoped key revoked successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KeyRevokeResponse'
              example:
                ok: true
                data:
                  id: key_1
                  revoked: true
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
  /capabilities/check:
    post:
      operationId: checkCapabilities
      tags:
        - Capabilities
      summary: Validate capability keys
      security: []
      description: |
        Check if given keys are valid and return their permissions.

        This endpoint validates up to 100 keys at once and returns:
        - Whether each key is valid
        - The permission level (read/append/write)
        - The scope type and ID
        - Error messages for invalid keys

        Keys are truncated in responses for security (only first 8 chars shown).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CapabilitiesCheckRequest'
            example:
              keys:
                - keyX8k2mP9qL3nR7mQ2pN4
                - a_x8k2mP9qL3nR7mQ2pN4x
      responses:
        '200':
          description: Capabilities checked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CapabilitiesCheckResponse'
              example:
                ok: true
                data:
                  results:
                    - key: keyX8k2m...
                      valid: true
                      permission: write
                      scope: workspace
                      scopeId: ws_123
                    - key: a_x8k2mP...
                      valid: false
                      error: EXPIRED
        '400':
          $ref: '#/components/responses/BadRequest'
  /api/auth/signin/github:
    get:
      operationId: signInWithGitHub
      tags:
        - Auth
      summary: Sign in with GitHub
      security: []
      description: |
        Initiate GitHub OAuth flow.

        Redirects to GitHub for authorization. On success, redirects back with
        session cookie set automatically.

        **When to use:** Only for Tier 2 (nuclear) operations:
        - Rotate ALL capability URLs
        - Delete workspace
        - Transfer ownership

        Most operations do NOT require OAuth - use capability URLs instead.
      responses:
        '200':
          description: OAuth flow initiated (for OpenAPI compliance - actual response is 302 redirect)
          content:
            application/json:
              schema:
                type: object
                description: This endpoint redirects to OAuth provider. 200 is for OpenAPI compliance only.
        '302':
          description: Redirect to GitHub OAuth
          headers:
            Location:
              description: GitHub OAuth authorization URL
              schema:
                type: string
                example: https://github.com/login/oauth/authorize?client_id=...
        '429':
          $ref: '#/components/responses/RateLimited'
  /api/auth/signin/google:
    get:
      operationId: signInWithGoogle
      tags:
        - Auth
      summary: Sign in with Google
      security: []
      description: |
        Initiate Google OAuth flow.

        Redirects to Google for authorization. On success, redirects back with
        session cookie set automatically.

        **When to use:** Only for Tier 2 (nuclear) operations:
        - Rotate ALL capability URLs
        - Delete workspace
        - Transfer ownership

        Most operations do NOT require OAuth - use capability URLs instead.
      responses:
        '200':
          description: OAuth flow initiated (for OpenAPI compliance - actual response is 302 redirect)
          content:
            application/json:
              schema:
                type: object
                description: This endpoint redirects to OAuth provider. 200 is for OpenAPI compliance only.
        '302':
          description: Redirect to Google OAuth
          headers:
            Location:
              description: Google OAuth authorization URL
              schema:
                type: string
                example: https://accounts.google.com/o/oauth2/v2/auth?client_id=...
        '429':
          $ref: '#/components/responses/RateLimited'
  /auth/me:
    get:
      operationId: getCurrentUser
      tags:
        - Auth
      summary: Get current user
      description: |
        Get the current authenticated user's information.

        Requires a valid OAuth session cookie (from GitHub/Google sign-in).
      security:
        - oauthSession: []
      responses:
        '200':
          description: User information retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MeResponse'
              example:
                ok: true
                data:
                  id: user_x8k2mP9qL3nR
                  email: user@example.com
                  name: Alex Developer
                  image: https://avatars.githubusercontent.com/u/12345
                  workspaces:
                    - id: ws_x8k2mP9qL3nR
                      name: My Project
                  createdAt: '2024-01-08T09:00:00Z'
                  webUrl: https://app.mdplane.dev/control
        '401':
          $ref: '#/components/responses/Unauthorized'
  /auth/logout:
    post:
      operationId: logout
      tags:
        - Auth
      summary: Logout
      description: |
        Logout and clear the OAuth session cookie.
      security:
        - oauthSession: []
      responses:
        '200':
          description: Logged out successfully
          headers:
            Set-Cookie:
              description: Clears session cookie
              schema:
                type: string
                example: better-auth.session_token=; Secure; HttpOnly; SameSite=Lax; Path=/; Max-Age=0
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogoutResponse'
              example:
                ok: true
                data:
                  status: logged_out
        '401':
          $ref: '#/components/responses/Unauthorized'
  /w/{key}/claim:
    post:
      operationId: claimWorkspace
      tags:
        - Claiming
      summary: Claim workspace
      description: |
        Claim ownership of a workspace. Requires the workspace's **write key** AND an OAuth session.

        **Requirements:**
        - Must be logged in via GitHub or Google OAuth
        - Must have the workspace's write key

        **Claiming rules:**
        - A workspace can only be claimed once
        - Claiming is optional — workspaces never expire
        - The claimer becomes the workspace owner
        - OAuth identity is used for ownership (no email verification needed)
      security:
        - oauthSession: []
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              description: Empty body - OAuth session provides identity
            example: {}
      responses:
        '200':
          description: Workspace claimed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClaimWorkspaceResponse'
              example:
                ok: true
                data:
                  workspaceId: ws_x8k2mP9qL3nR
                  claimed: true
                  message: claimed
        '400':
          description: Workspace already claimed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                ok: false
                error:
                  code: ALREADY_CLAIMED
                  message: Workspace is already claimed by another user
        '401':
          description: OAuth session required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                ok: false
                error:
                  code: UNAUTHORIZED
                  message: OAuth session required. Login via GitHub or Google first.
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
  /w/{key}/workspace:
    patch:
      operationId: renameWorkspaceViaWriteKey
      tags:
        - Workspaces
      summary: Rename workspace via write key
      security:
        - capabilityKeyAuth: []
      description: |
        Rename a workspace using a workspace-scoped write capability key.

        This endpoint is intended for capability-key workflows that need to
        rename workspaces without an OAuth session.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkspaceRenameRequest'
      responses:
        '200':
          description: Workspace renamed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkspaceRenameResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          description: Key is not allowed to rename workspace
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                ok: false
                error:
                  code: FORBIDDEN
                  message: Only workspace-scoped write keys can rename workspaces
        '404':
          $ref: '#/components/responses/NotFound'
  /workspaces/{workspaceId}:
    delete:
      operationId: deleteWorkspace
      tags:
        - Workspaces
      summary: Delete workspace
      description: |
        Permanently delete a workspace and ALL its contents.

        **⚠️ DESTRUCTIVE OPERATION - CANNOT BE UNDONE**

        This will delete:
        - All files and folders
        - All capability URLs (they become invalid)
        - All API keys
        - All webhooks
        - Ownership information

        **Requires:** OAuth session (GitHub/Google) and workspace ownership.
      security:
        - oauthSession: []
      parameters:
        - $ref: '#/components/parameters/workspaceId'
      responses:
        '200':
          description: Workspace deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              example:
                ok: true
                data:
                  message: Workspace deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  /workspaces/{workspaceId}/name:
    patch:
      operationId: renameWorkspace
      tags:
        - Workspaces
      summary: Rename workspace
      description: |
        Rename a workspace via OAuth account controls session.

        **Requires:** OAuth session (GitHub/Google) and workspace ownership.
      security:
        - oauthSession: []
      parameters:
        - $ref: '#/components/parameters/workspaceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkspaceRenameRequest'
      responses:
        '200':
          description: Workspace renamed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkspaceRenameResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  /workspaces/{workspaceId}/rotate-all:
    post:
      operationId: rotateAllUrls
      tags:
        - Workspaces
      summary: Rotate all capability URLs
      description: |
        Regenerate ALL capability URLs for this workspace.

        **⚠️ DESTRUCTIVE OPERATION**

        This will:
        - Generate new read/append/write keys for all files/folders
        - Invalidate ALL existing capability URLs
        - Break all integrations using old URLs
        - Return newly generated root read/append/write keys once in the response

        Use this when you suspect keys have been compromised.

        **Requires:** OAuth session (GitHub/Google) and workspace ownership.
      security:
        - oauthSession: []
      parameters:
        - $ref: '#/components/parameters/workspaceId'
      responses:
        '200':
          description: All URLs rotated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RotateAllResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  /workspaces/{workspaceId}/api-keys:
    post:
      operationId: createApiKey
      tags:
        - API Keys
      summary: Create API key
      description: |
        Create a new API key for programmatic workspace access.

        **Requires:** Session cookie (verified email) and workspace ownership.

        **Key format:** API keys start with `sk_` prefix:
        - `sk_live_...` for production
        - `sk_test_...` for test environments

        **Important:** The full key is only shown once at creation time. Store it securely.
        Keys are hashed before storage — we cannot recover lost keys.
      security:
        - oauthSession: []
      parameters:
        - $ref: '#/components/parameters/workspaceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApiKeyCreateRequest'
            example:
              name: CI Pipeline
              permissions:
                - read
                - append
              expiresInSeconds: 31536000
      responses:
        '201':
          description: API key created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiKeyCreateResponse'
              example:
                ok: true
                data:
                  id: key_1
                  key: sk_live_demoKey123
                  name: CI Pipeline
                  permissions:
                    - read
                    - append
                  createdAt: '2024-01-08T09:00:00Z'
                  expiresAt: '2025-01-08T09:00:00Z'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'
    get:
      operationId: listApiKeys
      tags:
        - API Keys
      summary: List API keys
      description: |
        List all API keys for a workspace.

        **Requires:** Session cookie (verified email) and workspace ownership.

        **Note:** Full key values are never returned after creation — only the prefix
        for identification.
      security:
        - oauthSession: []
      parameters:
        - $ref: '#/components/parameters/workspaceId'
      responses:
        '200':
          description: API keys retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiKeyListResponse'
              example:
                ok: true
                data:
                  keys:
                    - id: key_1
                      name: CI Pipeline
                      prefix: sk_live_x8k2...
                      permissions:
                        - read
                        - append
                      createdAt: '2024-01-08T09:00:00Z'
                      expiresAt: '2025-01-08T09:00:00Z'
                      lastUsedAt: '2024-01-10T14:30:00Z'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
  /workspaces/{workspaceId}/api-keys/{keyId}:
    delete:
      operationId: revokeApiKey
      tags:
        - API Keys
      summary: Revoke API key
      description: |
        Revoke (delete) an API key.

        **Requires:** Session cookie (verified email) and workspace ownership.

        Deletion is immediate. Any requests using this key will fail.
      security:
        - oauthSession: []
      parameters:
        - $ref: '#/components/parameters/workspaceId'
        - $ref: '#/components/parameters/keyId'
      responses:
        '200':
          description: API key revoked successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiKeyRevokeResponse'
              example:
                ok: true
                data:
                  id: key_1
                  revoked: true
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
  /w/{key}/webhooks:
    post:
      operationId: createWebhook
      tags:
        - Webhooks
      summary: Create webhook
      security:
        - capabilityKeyAuth: []
      description: |
        Register a new webhook to receive events for this file.

        Webhook URLs must use HTTPS and resolve to public IP addresses (SSRF protection).
        If `secret` is omitted, the server generates a secure 32-byte secret and returns
        it in the response (shown only once at creation).

        **Events:** Subscribe to specific events like `append`, `claim.expired`, `task.blocked`.
        **Filters:** Optionally narrow which events trigger the webhook by append type, labels, or priority.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookCreateRequest'
            example:
              url: https://example.com/webhook
              events:
                - append
                - claim.expired
                - task.blocked
              secret: my-secure-secret-at-least-32-chars
              includeUrls: false
              filters:
                types:
                  - task
                  - response
                labels:
                  - urgent
                priority:
                  - high
                  - critical
      responses:
        '201':
          description: Webhook created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookCreateResponse'
              example:
                ok: true
                data:
                  id: wh_1
                  url: https://example.com/webhook
                  events:
                    - append
                    - claim.expired
                    - task.blocked
                  status: active
                  createdAt: '2024-01-08T09:00:00Z'
        '400':
          description: |
            Invalid request. Possible error codes:
            - `INVALID_WEBHOOK_URL`: URL must use HTTPS and resolve to public IP
            - `INVALID_REQUEST`: Malformed request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '402':
          description: Webhook limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                ok: false
                error:
                  code: WEBHOOK_LIMIT_EXCEEDED
                  message: Free tier allows 3 webhook endpoints per file
                  details:
                    current: 3
                    limit: 3
                    tier: free
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
    get:
      operationId: listWebhooks
      tags:
        - Webhooks
      summary: List webhooks
      security:
        - capabilityKeyAuth: []
      description: |
        List all webhooks registered for this file.

        Returns webhook status, success rate, and last trigger time.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      responses:
        '200':
          description: Webhooks retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookListResponse'
              example:
                ok: true
                data:
                  - id: wh_1
                    url: https://example.com/webhook
                    events:
                      - append
                    status: active
                    lastTriggeredAt: '2024-01-08T10:30:00Z'
                    successRate: 0.98
                    createdAt: '2024-01-08T09:00:00Z'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /w/{key}/webhooks/{webhookId}:
    patch:
      operationId: updateWebhook
      tags:
        - Webhooks
      summary: Update webhook
      security:
        - capabilityKeyAuth: []
      description: |
        Partially update webhook configuration.

        Supports secret rotation with optional grace period for seamless key rollover.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/webhookId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookUpdateRequest'
            example:
              events:
                - append
                - task.blocked
              active: true
      responses:
        '200':
          description: Webhook updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookUpdateResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
    delete:
      operationId: deleteWebhook
      tags:
        - Webhooks
      summary: Delete webhook
      security:
        - capabilityKeyAuth: []
      description: |
        Delete a webhook. Events will no longer be delivered to this endpoint.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/webhookId'
      responses:
        '200':
          description: Webhook deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookDeleteResponse'
              example:
                ok: true
                data:
                  id: wh_1
                  deleted: true
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /w/{key}/webhooks/{webhookId}/logs:
    get:
      operationId: getWebhookLogs
      tags:
        - Webhooks
      summary: Get webhook delivery logs
      security:
        - capabilityKeyAuth: []
      description: |
        Get delivery logs for a webhook. Includes status, response code, duration, and any errors.

        Logs are retained for 7 days.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/webhookId'
        - name: limit
          in: query
          description: Maximum number of log entries to return
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 200
        - name: since
          in: query
          description: Return logs after this timestamp (ISO 8601)
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Webhook logs retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookLogsResponse'
              example:
                ok: true
                data:
                  logs:
                    - id: log_1
                      event: append
                      status: ok
                      responseCode: 200
                      timestamp: '2024-01-08T10:30:00Z'
                      durationMs: 145
                    - id: log_2
                      event: task.blocked
                      status: failed
                      responseCode: 500
                      timestamp: '2024-01-08T10:25:00Z'
                      durationMs: 2500
                      error: Server returned 500 Internal Server Error
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /w/{key}/webhooks/{webhookId}/test:
    post:
      operationId: testWebhook
      tags:
        - Webhooks
      summary: Test webhook
      security:
        - capabilityKeyAuth: []
      description: |
        Send a test event to the webhook endpoint. Useful for verifying connectivity
        and signature validation.

        If no event type is specified, defaults to `append.created`.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - $ref: '#/components/parameters/webhookId'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookTestRequest'
            example:
              event: append.created
      responses:
        '200':
          description: Test webhook delivered (or attempted)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookTestResponse'
              examples:
                success:
                  summary: Successful delivery
                  value:
                    ok: true
                    data:
                      delivered: true
                      responseCode: 200
                      durationMs: 145
                failure:
                  summary: Failed delivery
                  value:
                    ok: true
                    data:
                      delivered: false
                      responseCode: 500
                      durationMs: 2500
                      error: Server returned 500 Internal Server Error
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /workspaces/{workspaceId}/webhooks:
    get:
      operationId: listWorkspaceWebhooks
      tags:
        - Webhooks
      summary: List workspace webhooks
      security:
        - oauthSession: []
      description: |
        List webhooks configured for a workspace from account controls.
        Requires an authenticated session and workspace ownership.
      parameters:
        - $ref: '#/components/parameters/workspaceId'
      responses:
        '200':
          description: Webhooks retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    post:
      operationId: createWorkspaceWebhook
      tags:
        - Webhooks
      summary: Create workspace webhook
      security:
        - oauthSession: []
      description: |
        Create a workspace webhook from account controls.
        Requires workspace ownership.
      parameters:
        - $ref: '#/components/parameters/workspaceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookCreateRequest'
      responses:
        '201':
          description: Webhook created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookCreateResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  /workspaces/{workspaceId}/webhooks/{webhookId}:
    patch:
      operationId: updateWorkspaceWebhook
      tags:
        - Webhooks
      summary: Update workspace webhook
      security:
        - oauthSession: []
      description: |
        Update a workspace webhook from account controls.
        Requires workspace ownership.
      parameters:
        - $ref: '#/components/parameters/workspaceId'
        - $ref: '#/components/parameters/webhookId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookUpdateRequest'
      responses:
        '200':
          description: Webhook updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookUpdateResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      operationId: deleteWorkspaceWebhook
      tags:
        - Webhooks
      summary: Delete workspace webhook
      security:
        - oauthSession: []
      description: |
        Delete a workspace webhook from account controls.
        Requires workspace ownership.
      parameters:
        - $ref: '#/components/parameters/workspaceId'
        - $ref: '#/components/parameters/webhookId'
      responses:
        '200':
          description: Webhook deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookDeleteResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  /workspaces/{workspaceId}/webhooks/{webhookId}/test:
    post:
      operationId: testWorkspaceWebhook
      tags:
        - Webhooks
      summary: Test workspace webhook
      security:
        - oauthSession: []
      description: |
        Send a test delivery to a workspace webhook.
        Requires workspace ownership.
      parameters:
        - $ref: '#/components/parameters/workspaceId'
        - $ref: '#/components/parameters/webhookId'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookTestRequest'
      responses:
        '200':
          description: Test delivery attempted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookTestResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  /r/{key}/search:
    get:
      operationId: searchInFileViaReadKey
      tags:
        - Search
      summary: Scoped search via capability URL
      security:
        - capabilityKeyAuth: []
      description: |
        Search within the scope the capability URL grants access to.

        This is **lexical** full-text search (term-based), not semantic/embedding search.
        Results include **snippets** (relevant chunks) and highlights.

        **Deleted items are excluded**: files with `deleted_at` set are never returned.

        **Scoping:**
        - **File-scoped key:** Searches that file's content and its appends
        - **Folder-scoped key:** Searches file contents and appends within that folder scope
        - **Workspace-scoped key:** Searches file contents and appends within the whole workspace

        **Query semantics:**
        - `q` is treated as plain text (special operator syntax is not supported in v1).

        **Filters:**
        - `q`: Full-text search query
        - `type`: Filter by append type (task, claim, response, comment, etc.)
        - `status`: Filter tasks by status (pending, claimed, completed, cancelled)
        - `author`: Filter by author name
        - `labels`: Filter by labels (comma-separated, OR matching)
        - `priority`: Filter by priority levels
        - `since`: Return results after this timestamp
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - name: q
          in: query
          description: Full-text search query
          schema:
            type: string
            maxLength: 500
        - name: type
          in: query
          description: Filter by append type
          schema:
            type: string
            enum:
              - task
              - claim
              - response
              - blocked
              - answer
              - renew
              - cancel
              - comment
              - vote
        - name: status
          in: query
          description: Filter by task status
          schema:
            type: string
            enum:
              - pending
              - claimed
              - completed
              - cancelled
        - name: author
          in: query
          description: Filter by author name
          schema:
            type: string
        - name: labels
          in: query
          description: Filter by labels (comma-separated, OR matching)
          schema:
            type: string
        - name: priority
          in: query
          description: Filter by priority levels (comma-separated)
          schema:
            type: string
        - name: since
          in: query
          description: Return results after this timestamp (ISO 8601)
          schema:
            type: string
            format: date-time
        - name: limit
          in: query
          description: Maximum number of results to return
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 200
        - name: cursor
          in: query
          description: Pagination cursor from previous response
          schema:
            type: string
      responses:
        '200':
          description: Search results retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /api/v1/search:
    get:
      operationId: searchWorkspace
      tags:
        - Search
      summary: Search entire workspace
      description: |
        Search across all files in the workspace. Requires API key authentication.

        This is **lexical** full-text search (term-based), not semantic/embedding search.
        Results include **snippets** (relevant chunks) and highlights.

        **Deleted items are excluded**: files with `deleted_at` set are never returned.

        Supports all the same filters as file-level search, plus:
        - `folder`: Limit search to a specific folder path

        **Frontmatter Query:** Use `frontmatter.` prefix to filter by frontmatter fields.
        Example: `?frontmatter.skills=security&frontmatter.status=active`
      security:
        - bearerAuth: []
      parameters:
        - name: q
          in: query
          description: Full-text search query
          schema:
            type: string
            maxLength: 500
        - name: type
          in: query
          description: Filter by append type
          schema:
            type: string
            enum:
              - task
              - claim
              - response
              - blocked
              - answer
              - renew
              - cancel
              - comment
              - vote
        - name: folder
          in: query
          description: Limit search to a specific folder path
          schema:
            type: string
        - name: status
          in: query
          description: Filter by task status
          schema:
            type: string
            enum:
              - pending
              - claimed
              - completed
              - cancelled
        - name: author
          in: query
          description: Filter by author name
          schema:
            type: string
        - name: labels
          in: query
          description: Filter by labels (comma-separated, OR matching)
          schema:
            type: string
        - name: priority
          in: query
          description: Filter by priority levels (comma-separated)
          schema:
            type: string
        - name: since
          in: query
          description: Return results after this timestamp (ISO 8601)
          schema:
            type: string
            format: date-time
        - name: limit
          in: query
          description: Maximum number of results to return
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 200
        - name: cursor
          in: query
          description: Pagination cursor from previous response
          schema:
            type: string
      responses:
        '200':
          description: Search results retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'
              example:
                ok: true
                data:
                  results:
                    - type: file
                      id: file_1
                      file:
                        id: file_1
                        path: /projects/alpha/tasks.md
                      content: Project Alpha task list
                      highlights:
                        - start: 8
                          end: 13
                      score: 0.92
                    - type: task
                      id: a1
                      file:
                        id: file_1
                        path: /projects/alpha/tasks.md
                      content: Review API design
                      highlights:
                        - start: 7
                          end: 10
                      score: 0.88
                  total: 42
                pagination:
                  cursor: xyz789
                  hasMore: true
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
  /r/{key}/ops/subscribe:
    get:
      operationId: subscribeReadKey
      tags:
        - Realtime
      summary: WebSocket subscription (read-only events)
      security:
        - capabilityKeyAuth: []
      description: |
        Get WebSocket subscription credentials for real-time event streaming.

        Read key subscriptions receive file-level events only:
        - `append`: Any append added to file
        - `file.created`: File created in watched folder
        - `file.deleted`: File deleted
        - `file.updated`: File content changed

        **WebSocket Message Types:**
        - `connected`: Initial connection confirmation
        - `append`: New append event
        - `heartbeat`: Server keepalive ping
        - `file.updated`: File content changed
        - `error`: Error notification

        Returns 101 Switching Protocols for WebSocket upgrade on successful connection.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      responses:
        '101':
          description: WebSocket connection established (Switching Protocols)
        '200':
          description: WebSocket upgrade successful (for OpenAPI compliance)
          content:
            application/json:
              schema:
                type: object
                description: This endpoint upgrades to WebSocket. 200 is for OpenAPI compliance only.
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /a/{key}/ops/subscribe:
    get:
      operationId: subscribeAppendKey
      tags:
        - Realtime
      summary: WebSocket subscription (append events)
      security:
        - capabilityKeyAuth: []
      description: |
        Get WebSocket subscription credentials for real-time event streaming.

        Append key subscriptions receive all read events plus task/claim lifecycle events:
        - `append`: Any append added to file
        - `file.created`: File created in watched folder
        - `file.deleted`: File deleted
        - `file.updated`: File content changed
        - `task.created`: New task append added
        - `task.completed`: Task received response
        - `task.cancelled`: Task was cancelled
        - `task.blocked`: Agent marked task blocked
        - `task.unblocked`: Blocked task received answer
        - `task.overdue`: Task passed due date.
        - `task.escalated`: Task escalated to human
        - `task.recurred`: Recurring task created new instance
        - `claim.created`: Task was claimed
        - `claim.expired`: Claim not renewed in time
        - `claim.renewed`: Claim timer extended
        - `heartbeat`: Agent liveness signal

        **WebSocket Message Types:**
        - `connected`: Initial connection confirmation
        - `append`: New append event
        - `heartbeat`: Server keepalive ping
        - `file.updated`: File content changed
        - `error`: Error notification

        Returns 101 Switching Protocols for WebSocket upgrade on successful connection.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      responses:
        '101':
          description: WebSocket connection established (Switching Protocols)
        '200':
          description: WebSocket upgrade successful (for OpenAPI compliance)
          content:
            application/json:
              schema:
                type: object
                description: This endpoint upgrades to WebSocket. 200 is for OpenAPI compliance only.
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /w/{key}/ops/subscribe:
    get:
      operationId: subscribeWriteKey
      tags:
        - Realtime
      summary: WebSocket subscription (all events including write-level events)
      security:
        - capabilityKeyAuth: []
      description: |
        Get WebSocket subscription credentials for real-time event streaming.

        Write key subscriptions receive all events including write-level events:
        - All read events (`append`, `file.created`, `file.deleted`, `file.updated`)
        - All append events (task/claim lifecycle)
        - `webhook.failed`: Webhook delivery failed
        - `settings.changed`: File/folder settings modified

        **WebSocket Message Types:**
        - `connected`: Initial connection confirmation
        - `append`: New append event
        - `heartbeat`: Server keepalive ping
        - `file.updated`: File content changed
        - `error`: Error notification

        Returns 101 Switching Protocols for WebSocket upgrade on successful connection.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      responses:
        '101':
          description: WebSocket connection established (Switching Protocols)
        '200':
          description: WebSocket upgrade successful (for OpenAPI compliance)
          content:
            application/json:
              schema:
                type: object
                description: This endpoint upgrades to WebSocket. 200 is for OpenAPI compliance only.
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /a/{key}/heartbeat:
    post:
      operationId: recordHeartbeat
      tags:
        - Realtime
      summary: Record agent heartbeat
      security:
        - capabilityKeyAuth: []
      description: |
        Record an agent heartbeat to signal liveness. Updates the agent's "last seen"
        timestamp without cluttering the file with appends.

        Heartbeats are stored separately from regular appends and do not increment
        the append counter.

        **Author Identity:**
        - Default keys (`boundAuthor: null`): Author is self-declared
        - Scoped keys (`boundAuthor: "agent-alpha"`): Server validates author matches
          `boundAuthor`. Returns 400 AUTHOR_MISMATCH if mismatched.

        **Rate limiting:** Subject to standard append rate limits (60 req/min per capability URL).
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HeartbeatRequest'
            example:
              author: agent-alpha
              status: alive
              currentTask: a42
              metadata:
                version: 1.2.0
                lastAction: processing
      responses:
        '201':
          description: Heartbeat recorded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HeartbeatResponse'
              example:
                ok: true
                data:
                  id: hb_x8k2mP9qL3nR
                  author: agent-alpha
                  ts: '2024-01-10T10:30:00Z'
                  expiresAt: '2024-01-10T10:35:00Z'
                  nextHeartbeatBy: '2024-01-10T10:34:30Z'
        '400':
          description: |
            Invalid request. Possible error codes:
            - `INVALID_AUTHOR`: Author field fails validation
            - `AUTHOR_MISMATCH`: Heartbeat author doesn't match scoped key's boundAuthor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                authorMismatch:
                  summary: Author mismatch for scoped key
                  value:
                    ok: false
                    error:
                      code: AUTHOR_MISMATCH
                      message: Key is bound to author 'agent-alpha', but heartbeat author is 'kai'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /w/{key}/ops/stats:
    get:
      operationId: getStatsViaWriteKey
      tags:
        - Stats
      summary: Get file/folder/workspace statistics (write key)
      security:
        - capabilityKeyAuth: []
      description: |
        Returns statistics for the scope of the write key.

        Provides scope-aware statistics including:
        - Scope info (type and id)
        - Counts (files, appends, tasks, claims, agents)
        - Activity (last append, appends today/this week)
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      responses:
        '200':
          description: Statistics retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsViaWriteKeyResponse'
        '403':
          description: Invalid or insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsErrorResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
  /r/{key}/ops/file/stats:
    get:
      operationId: getFileStatsViaReadKey
      tags:
        - Stats
      summary: Get file statistics (read key)
      security:
        - capabilityKeyAuth: []
      description: |
        Returns statistics for a specific file including append counts and task statistics.

        Provides:
        - Total append count
        - Task statistics (pending, claimed, completed, active claims)
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      responses:
        '200':
          description: File statistics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileStatsResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /a/{key}/ops/file/stats:
    get:
      operationId: getFileStats
      tags:
        - Stats
      summary: Get file statistics
      security:
        - capabilityKeyAuth: []
      description: |
        Returns statistics for a specific file including append counts and task statistics.

        Provides:
        - Total append count
        - Task statistics (pending, claimed, completed, active claims)
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      responses:
        '200':
          description: File statistics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileStatsResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /api/v1/stats:
    get:
      operationId: getWorkspaceStats
      tags:
        - Stats
      summary: Get workspace statistics
      description: |
        Returns comprehensive statistics for the entire workspace.

        Requires API key authentication via Bearer token.

        Provides:
        - File and folder counts
        - Total storage usage and limits
        - Append counts and task statistics
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Workspace statistics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkspaceStatsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
  /j/{key}:
    get:
      operationId: pollJobStatus
      tags:
        - Jobs
      summary: Poll async job status
      security:
        - capabilityKeyAuth: []
      description: |
        Poll the status of an asynchronous job. Job poll URLs use capability keys
        (same format as file keys) to prevent job ID guessing.

        Jobs complete within 60 seconds or fail.

        **Job lifecycle:**
        - `pending`: Job is queued, waiting to start
        - `processing`: Job is currently running
        - `completed`: Job finished successfully, result available
        - `failed`: Job encountered an error

        Job poll URLs expire after the job completes + 1 hour.
      parameters:
        - name: key
          in: path
          required: true
          description: Job capability key (same format as file keys)
          schema:
            type: string
            pattern: ^[A-Za-z0-9_]{20,}$
            minLength: 20
      responses:
        '200':
          description: Job status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
              examples:
                pending:
                  summary: Job pending
                  value:
                    ok: true
                    data:
                      id: job_xyz
                      status: pending
                      createdAt: '2024-01-08T10:30:00Z'
                processing:
                  summary: Job processing
                  value:
                    ok: true
                    data:
                      id: job_xyz
                      status: processing
                      progress:
                        current: 15
                        total: 50
                        message: Processing files...
                      createdAt: '2024-01-08T10:30:00Z'
                completed:
                  summary: Job completed
                  value:
                    ok: true
                    data:
                      id: job_xyz
                      status: completed
                      result:
                        created:
                          - filename: README.md
                            id: x1
                          - filename: TODO.md
                            id: x2
                      createdAt: '2024-01-08T10:30:00Z'
                      completedAt: '2024-01-08T10:31:00Z'
                failed:
                  summary: Job failed
                  value:
                    ok: true
                    data:
                      id: job_xyz
                      status: failed
                      error:
                        code: PARTIAL_FAILURE
                        message: 3 files failed to create
                      createdAt: '2024-01-08T10:30:00Z'
                      completedAt: '2024-01-08T10:31:00Z'
        '404':
          description: Job not found or expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                ok: false
                error:
                  code: JOB_NOT_FOUND
                  message: Job not found or expired
        '429':
          $ref: '#/components/responses/RateLimited'
  /api/v1/export:
    get:
      operationId: exportWorkspace
      tags:
        - Export
      summary: Export workspace (synchronous)
      description: |
        Download all workspace data as a single archive. For workspaces under 500MB.

        **Required scope:** API key must have `export` scope.

        **Security Note:** All exports are logged with full context (who, when, scope, IP).
        Workspace owners receive email notification when exports occur.
      security:
        - bearerAuth: []
      parameters:
        - name: format
          in: query
          description: Archive format
          schema:
            type: string
            enum:
              - zip
              - tar.gz
            default: zip
        - name: includeAppends
          in: query
          description: Include append history in metadata
          schema:
            type: boolean
            default: false
        - name: includeDeleted
          in: query
          description: Include soft-deleted files
          schema:
            type: boolean
            default: false
        - name: paths
          in: query
          description: Comma-separated folder paths to export (exports all if omitted)
          schema:
            type: string
      responses:
        '200':
          description: Binary file download
          headers:
            Content-Disposition:
              description: Attachment filename
              schema:
                type: string
                example: attachment; filename="workspace-export-2026-01-11.zip"
            X-Export-Checksum:
              description: SHA-256 checksum for integrity verification
              schema:
                type: string
                example: sha256:abc123...
          content:
            application/zip:
              schema:
                type: string
                format: binary
            application/gzip:
              schema:
                type: string
                format: binary
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '413':
          description: Workspace too large for synchronous export
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                ok: false
                error:
                  code: WORKSPACE_TOO_LARGE
                  message: Workspace exceeds 500MB sync export limit. Use async export.
                  details:
                    currentSize: 750MB
                    syncLimit: 500MB
        '429':
          $ref: '#/components/responses/RateLimited'
  /api/v1/export/jobs:
    post:
      operationId: createExportJob
      tags:
        - Export
      summary: Create async export job
      description: |
        Create an asynchronous export job for large workspaces (over 500MB) or by preference.

        **Required scope:** API key must have `export` scope.

        Download links expire after 24 hours.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                format:
                  type: string
                  enum:
                    - zip
                    - tar.gz
                  default: zip
                includeAppends:
                  type: boolean
                  default: false
                  description: Include append history in metadata
                includeDeleted:
                  type: boolean
                  default: false
                  description: Include soft-deleted files
                paths:
                  type: array
                  items:
                    type: string
                  description: Folder paths to export (exports all if omitted)
                notifyEmail:
                  type: string
                  format: email
                  description: Email to notify when export is ready
      responses:
        '202':
          description: Export job created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportJobCreateResponse'
              example:
                ok: true
                data:
                  jobId: exp_abc123
                  status: queued
                  statusUrl: /api/v1/export/jobs/exp_abc123
                  estimatedSize: 2.3GB
                  position: 3
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '413':
          description: Workspace exceeds maximum export size
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                ok: false
                error:
                  code: WORKSPACE_TOO_LARGE
                  message: Workspace exceeds 10GB export limit
                  details:
                    currentSize: 12.4GB
                    limit: 10GB
                    suggestion: Use folder-level export for individual folders
        '429':
          $ref: '#/components/responses/RateLimited'
  /api/v1/export/jobs/{jobId}:
    get:
      operationId: getExportJobStatus
      tags:
        - Export
      summary: Get export job status
      description: |
        Check the status of an async export job. When complete, includes a download URL.

        Download URLs expire after 24 hours.
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/jobId'
      responses:
        '200':
          description: Export job status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportJobStatusResponse'
              examples:
                processing:
                  summary: Export in progress
                  value:
                    ok: true
                    data:
                      id: exp_abc123
                      status: processing
                      progress:
                        filesProcessed: 1250
                        totalFiles: 3400
                        bytesWritten: 2.1GB
                      startedAt: '2026-01-11T14:30:00Z'
                ready:
                  summary: Export ready for download
                  value:
                    ok: true
                    data:
                      id: exp_abc123
                      status: ready
                      downloadUrl: /api/v1/export/jobs/exp_abc123/download
                      expiresAt: '2026-01-12T14:30:00Z'
                      checksum: sha256:abc123...
                      size: 2.4GB
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
  /api/v1/export/jobs/{jobId}/download:
    get:
      operationId: downloadExportJob
      tags:
        - Export
      summary: Download export archive
      description: |
        Download the completed export archive for a specific job.

        **Required scope:** API key must have `export` scope.

        Download is only available when job status is `ready`. Returns binary stream
        of the archive file (ZIP or tar.gz format).

        Security note: All downloads are logged with full context for audit purposes.
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/jobId'
      responses:
        '200':
          description: Binary file download
          headers:
            Content-Disposition:
              description: Attachment filename
              schema:
                type: string
                example: attachment; filename="workspace-export-2026-01-11.zip"
            X-Export-Checksum:
              description: SHA-256 checksum for integrity verification
              schema:
                type: string
                example: sha256:abc123...
          content:
            application/zip:
              schema:
                type: string
                format: binary
            application/gzip:
              schema:
                type: string
                format: binary
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Job not ready for download
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                ok: false
                error:
                  code: JOB_NOT_READY
                  message: Export job is not ready for download yet
                  details:
                    status: processing
        '404':
          description: Export job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                ok: false
                error:
                  code: JOB_NOT_FOUND
                  message: Export job not found
        '429':
          $ref: '#/components/responses/RateLimited'
  /api/v1/deleted:
    get:
      operationId: listDeletedFiles
      tags:
        - Export
      summary: List deleted files (recoverable)
      description: |
        List soft-deleted files that are still recoverable. Files are recoverable for 7 days
        after deletion.

        **Required scope:** API key must have `admin` scope.

        Deleted content may contain sensitive data. This endpoint is for compliance/backup
        scenarios requiring deleted file recovery.
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/cursor'
      responses:
        '200':
          description: List of recoverable deleted files
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeletedFilesListResponse'
              example:
                ok: true
                data:
                  files:
                    - id: x8k2m
                      path: /projects/alpha/old-notes.md
                      deletedAt: '2026-01-08T10:00:00Z'
                      expiresAt: '2026-01-15T10:00:00Z'
                      size: 2048
                    - id: y9m3n
                      path: /archive/deprecated.md
                      deletedAt: '2026-01-07T14:30:00Z'
                      expiresAt: '2026-01-14T14:30:00Z'
                      deletedBy: admin
                      size: 4096
                pagination:
                  hasMore: false
                  total: 2
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimited'
  /api/v1/agents/liveness:
    get:
      operationId: getAgentLiveness
      tags:
        - Agents
      summary: Agent liveness status
      description: |
        Returns liveness status for all agents that have sent heartbeats in the workspace.

        An agent is considered "stale" if no heartbeat received within the stale threshold
        (default: 5 minutes, configurable via query param or workspace settings).
      security:
        - bearerAuth: []
      parameters:
        - name: staleThresholdSeconds
          in: query
          description: Seconds before an agent is considered stale (default 300 = 5 minutes)
          schema:
            type: integer
            default: 300
            minimum: 60
            maximum: 3600
        - name: folder
          in: query
          description: Limit to agents active in a specific folder
          schema:
            type: string
      responses:
        '200':
          description: Agent liveness data retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentLivenessResponse'
              example:
                ok: true
                data:
                  agents:
                    - author: kai
                      status: alive
                      lastSeen: '2024-01-10T10:30:00Z'
                      stale: false
                      currentTask: t42
                    - author: worker-1
                      status: alive
                      lastSeen: '2024-01-10T09:00:00Z'
                      stale: true
                  staleThresholdSeconds: 300
                  webUrl: https://app.mdplane.dev/control/ws_xxx/agents
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
  /r/{key}/agents/liveness:
    get:
      operationId: getScopedAgentLiveness
      tags:
        - Agents
      summary: Scoped agent liveness
      security:
        - capabilityKeyAuth: []
      description: |
        Returns liveness for agents that have sent heartbeats to the specific file or folder.
        Same response format as workspace-level endpoint.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - name: staleThresholdSeconds
          in: query
          description: Seconds before an agent is considered stale (default 300 = 5 minutes)
          schema:
            type: integer
            default: 300
            minimum: 60
            maximum: 3600
      responses:
        '200':
          description: Agent liveness data retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentLivenessResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
  /r/{key}/orchestration:
    get:
      operationId: getOrchestrationReadOnly
      tags:
        - Orchestration
      summary: Read-only orchestration view
      security:
        - capabilityKeyAuth: []
      description: |
        Get a comprehensive view of all tasks and claims across the accessible scope.
        Designed for orchestrators and account controls views that need to monitor agent activity.

        Returns pending tasks, active claims, agent liveness, and workload distribution.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - name: status
          in: query
          description: Filter by task status (comma-separated; pending, claimed, stalled, completed, cancelled)
          schema:
            type: string
            pattern: ^(pending|claimed|stalled|completed|cancelled)(,(pending|claimed|stalled|completed|cancelled))*$
          example: pending,claimed
        - name: agent
          in: query
          description: Filter by claiming agent
          schema:
            type: string
        - name: file
          in: query
          description: Filter by filename (partial match)
          schema:
            type: string
        - name: folder
          in: query
          description: Filter by folder path
          schema:
            type: string
        - name: priority
          in: query
          description: Filter by priority (comma-separated; low, medium, high, critical)
          schema:
            type: string
            pattern: ^(low|medium|high|critical)(,(low|medium|high|critical))*$
          example: high,critical
        - $ref: '#/components/parameters/since'
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/cursor'
      responses:
        '200':
          description: Orchestration data retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrchestrationReadOnlyResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
  /w/{key}/orchestration:
    get:
      operationId: getOrchestrationAdmin
      tags:
        - Orchestration
      summary: Write-level orchestration view
      security:
        - capabilityKeyAuth: []
      description: |
        Get a comprehensive view of all tasks and claims with write-level capabilities.

        Same response as read-only view, plus ability to force-expire claims
        via the returned claim IDs.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - name: status
          in: query
          description: Filter by task status (comma-separated; pending, claimed, stalled, completed, cancelled)
          schema:
            type: string
            pattern: ^(pending|claimed|stalled|completed|cancelled)(,(pending|claimed|stalled|completed|cancelled))*$
          example: pending,claimed
        - name: agent
          in: query
          description: Filter by claiming agent
          schema:
            type: string
        - name: file
          in: query
          description: Filter by filename (partial match)
          schema:
            type: string
        - name: folder
          in: query
          description: Filter by folder path
          schema:
            type: string
        - name: priority
          in: query
          description: Filter by priority (comma-separated; low, medium, high, critical)
          schema:
            type: string
            pattern: ^(low|medium|high|critical)(,(low|medium|high|critical))*$
          example: high,critical
        - $ref: '#/components/parameters/since'
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/cursor'
      responses:
        '200':
          description: Orchestration data retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrchestrationAdminResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
  /workspaces/{workspaceId}/orchestration:
    get:
      operationId: getWorkspaceOrchestration
      tags:
        - Orchestration
      summary: Get workspace orchestration board
      security:
        - oauthSession: []
      description: |
        Get a comprehensive view of all tasks and claims in a workspace.

        Returns the same shape as `/r/{key}/orchestration` for unified client handling.

        **Requires:** OAuth session and workspace ownership.
      parameters:
        - $ref: '#/components/parameters/workspaceId'
        - name: status
          in: query
          description: Filter by task status (comma-separated; pending, claimed, stalled, completed, cancelled)
          schema:
            type: string
            pattern: ^(pending|claimed|stalled|completed|cancelled)(,(pending|claimed|stalled|completed|cancelled))*$
          example: pending,claimed
        - name: agent
          in: query
          description: Filter by claiming agent
          schema:
            type: string
        - name: file
          in: query
          description: Filter by filename (partial match)
          schema:
            type: string
        - name: folder
          in: query
          description: Filter by folder path
          schema:
            type: string
        - name: priority
          in: query
          description: Filter by priority (comma-separated; low, medium, high, critical)
          schema:
            type: string
            pattern: ^(low|medium|high|critical)(,(low|medium|high|critical))*$
          example: high,critical
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/cursor'
      responses:
        '200':
          description: Orchestration data retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrchestrationReadOnlyResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
  /workspaces/{workspaceId}/orchestration/claims/{claimId}/renew:
    post:
      operationId: renewClaimWorkspace
      tags:
        - Orchestration
      summary: Renew a claim via workspace orchestration
      security:
        - oauthSession: []
      description: |
        Extend the expiration time of an active claim.

        **Requires:** OAuth session and workspace ownership.
      parameters:
        - $ref: '#/components/parameters/workspaceId'
        - $ref: '#/components/parameters/claimId'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RenewClaimRequest'
      responses:
        '200':
          description: Claim renewed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClaimMutationResponse'
        '400':
          description: Cannot renew claim
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  /workspaces/{workspaceId}/orchestration/claims/{claimId}/complete:
    post:
      operationId: completeClaimWorkspace
      tags:
        - Orchestration
      summary: Complete a claim via workspace orchestration
      security:
        - oauthSession: []
      description: |
        Mark a claimed task as completed.

        **Requires:** OAuth session and workspace ownership.
      parameters:
        - $ref: '#/components/parameters/workspaceId'
        - $ref: '#/components/parameters/claimId'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompleteClaimRequest'
      responses:
        '200':
          description: Task completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClaimMutationResponse'
        '400':
          description: Cannot complete claim
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  /workspaces/{workspaceId}/orchestration/claims/{claimId}/cancel:
    post:
      operationId: cancelClaimWorkspace
      tags:
        - Orchestration
      summary: Cancel a claim via workspace orchestration
      security:
        - oauthSession: []
      description: |
        Abandon a claim, returning the task to pending status.

        **Requires:** OAuth session and workspace ownership.
      parameters:
        - $ref: '#/components/parameters/workspaceId'
        - $ref: '#/components/parameters/claimId'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CancelClaimRequest'
      responses:
        '200':
          description: Claim cancelled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClaimMutationResponse'
        '400':
          description: Cannot cancel claim
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  /workspaces/{workspaceId}/orchestration/claims/{claimId}/block:
    post:
      operationId: blockClaimWorkspace
      tags:
        - Orchestration
      summary: Block a claim via workspace orchestration
      security:
        - oauthSession: []
      description: |
        Mark a claim as blocked with a reason.

        **Requires:** OAuth session and workspace ownership.
      parameters:
        - $ref: '#/components/parameters/workspaceId'
        - $ref: '#/components/parameters/claimId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BlockClaimRequest'
      responses:
        '200':
          description: Claim marked as blocked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClaimMutationResponse'
        '400':
          description: Cannot block claim (missing reason or not active)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  /api/v1/files/{path}:
    get:
      operationId: apiReadFileByPath
      tags:
        - API
      summary: Read file by path
      description: |
        Read file content by workspace-relative path.

        Requires API key with `read` scope.

        The path is URL-encoded (e.g., `/api/v1/files/projects%2Falpha%2Fnotes.md`).
      security:
        - bearerAuth: []
      parameters:
        - name: path
          in: path
          required: true
          description: URL-encoded file path (e.g., projects/alpha/notes.md)
          schema:
            type: string
        - $ref: '#/components/parameters/format'
      responses:
        '200':
          description: File content retrieved successfully
          headers:
            ETag:
              description: Content version hash for optimistic concurrency
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileReadResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
    post:
      operationId: apiCreateFileByPath
      tags:
        - API
      summary: Create file by path
      description: |
        Create a new file at the specified path.

        Requires API key with `append` or `write` scope.

        If parent folders don't exist, they are created automatically.
      security:
        - bearerAuth: []
      parameters:
        - name: path
          in: path
          required: true
          description: URL-encoded file path for the new file
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - content
              properties:
                content:
                  type: string
                  description: Initial file content (markdown)
                initialAppends:
                  type: array
                  description: Optional initial appends to add after file creation
                  items:
                    $ref: '#/components/schemas/AppendRequest'
      responses:
        '201':
          description: File created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileCreateResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '429':
          $ref: '#/components/responses/RateLimited'
    put:
      operationId: apiUpdateFileByPath
      tags:
        - API
      summary: Update file by path
      description: |
        Replace entire file content at the specified path.

        Requires API key with `write` scope.

        Use `If-Match` header with ETag for optimistic concurrency control.
        If omitted, last-write-wins.
      security:
        - bearerAuth: []
      parameters:
        - name: path
          in: path
          required: true
          description: URL-encoded file path
          schema:
            type: string
        - name: If-Match
          in: header
          description: ETag from previous read for optimistic concurrency
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FileUpdateRequest'
      responses:
        '200':
          description: File updated successfully
          headers:
            ETag:
              description: New content version hash
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileUpdateResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '412':
          description: ETag mismatch - file was modified since last read
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimited'
    delete:
      operationId: apiDeleteFileByPath
      tags:
        - API
      summary: Delete file by path
      description: |
        Delete a file at the specified path.

        Requires API key with `write` scope.

        Soft delete by default (recoverable for 7 days).
        Use `?permanent=true` for hard delete (irreversible).
      security:
        - bearerAuth: []
      parameters:
        - name: path
          in: path
          required: true
          description: URL-encoded file path
          schema:
            type: string
        - name: permanent
          in: query
          description: Hard delete (irreversible)
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: File deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileDeleteResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          $ref: '#/components/responses/RateLimited'
  /api/v1/files/{path}/append:
    post:
      operationId: apiAppendToFileByPath
      tags:
        - API
      summary: Append to file by path
      description: |
        Append content to a file at the specified path.

        Requires API key with `append` or `write` scope.

        Supports all append types: task, claim, response, comment, blocked, answer, renew, cancel, vote.
      security:
        - bearerAuth: []
      parameters:
        - name: path
          in: path
          required: true
          description: URL-encoded file path
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AppendRequest'
            examples:
              task:
                summary: Create a task
                value:
                  author: ci-bot
                  type: task
                  content: Review PR
                  priority: high
                  labels:
                    - bug
                    - backend
              comment:
                summary: Add a comment
                value:
                  author: ci-bot
                  type: comment
                  content: Build passed ✓
              claim:
                summary: Claim a task
                value:
                  author: agent-alpha
                  type: claim
                  ref: a1
                  content: Starting work on this task
      responses:
        '201':
          description: Append created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppendResponse'
        '400':
          description: |
            Invalid request. Possible error codes:
            - `INVALID_APPEND_TYPE`: Unknown type value
            - `INVALID_REF`: ref points to wrong append type or doesn't exist
            - `INVALID_AUTHOR`: Author field fails validation
            - `TASK_ALREADY_COMPLETE`: Trying to claim a completed task
            - `ALREADY_CLAIMED`: Task already has active claim
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          $ref: '#/components/responses/Gone'
        '429':
          description: |
            Rate limited. Possible error codes:
            - `RATE_LIMITED`: Too many requests
            - `WIP_LIMIT_EXCEEDED`: Author at max concurrent claims
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/v1/folders:
    get:
      operationId: apiListRootFolder
      tags:
        - API
      summary: List root folder
      description: |
        List contents of the workspace root folder.

        Requires API key with `read` scope.

        Returns files and subfolders at the workspace root.
      security:
        - bearerAuth: []
      parameters:
        - name: recursive
          in: query
          description: Include all nested contents recursively
          schema:
            type: boolean
            default: false
        - name: depth
          in: query
          description: Return nested tree structure up to N levels deep (default 1, max 5)
          schema:
            type: integer
            minimum: 1
            maximum: 5
            default: 1
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/cursor'
      responses:
        '200':
          description: Folder contents retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderListResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimited'
    post:
      operationId: apiCreateRootFolder
      tags:
        - API
      summary: Create folder at root
      description: |
        Create a new folder at the workspace root.

        Requires API key with `write` scope.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  description: New folder name
                  maxLength: 255
      responses:
        '201':
          description: Folder created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderCreateResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '429':
          $ref: '#/components/responses/RateLimited'
  /api/v1/folders/{path}:
    get:
      operationId: apiListFolderByPath
      tags:
        - API
      summary: List folder by path
      description: |
        List contents of a folder at the specified path.

        Requires API key with `read` scope.

        Returns files and subfolders with their metadata.
      security:
        - bearerAuth: []
      parameters:
        - name: path
          in: path
          required: true
          description: URL-encoded folder path (use empty string or "/" for root)
          schema:
            type: string
        - name: recursive
          in: query
          description: Include all nested contents recursively
          schema:
            type: boolean
            default: false
        - name: depth
          in: query
          description: Return nested tree structure up to N levels deep (default 1, max 5)
          schema:
            type: integer
            minimum: 1
            maximum: 5
            default: 1
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/cursor'
      responses:
        '200':
          description: Folder contents retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderListResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
    post:
      operationId: apiCreateFolderByPath
      tags:
        - API
      summary: Create folder by path
      description: |
        Create a new folder at the specified path.

        Requires API key with `write` scope.

        Parent folders are created automatically if they don't exist.
      security:
        - bearerAuth: []
      parameters:
        - name: path
          in: path
          required: true
          description: URL-encoded parent folder path
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  description: New folder name
                  maxLength: 255
      responses:
        '201':
          description: Folder created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderCreateResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '429':
          $ref: '#/components/responses/RateLimited'
    delete:
      operationId: apiDeleteFolderByPath
      tags:
        - API
      summary: Delete folder by path
      description: |
        Delete a folder at the specified path.

        Requires API key with `write` scope.

        Empty folders are deleted directly. For non-empty folders, use cascade delete
        with confirmation by setting `cascade: true` and `confirmPath` matching the
        folder path exactly.

        Cascade delete is soft delete only — all files remain recoverable for 7 days.
      security:
        - bearerAuth: []
      parameters:
        - name: path
          in: path
          required: true
          description: URL-encoded folder path
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                cascade:
                  type: boolean
                  description: Delete folder and all contents
                confirmPath:
                  type: string
                  description: Must match folder path exactly (without leading slash) for cascade delete
      responses:
        '200':
          description: Folder deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderDeleteResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Folder not empty (use cascade delete)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimited'
  /health:
    get:
      operationId: healthCheck
      tags:
        - System
      summary: Health check (liveness probe)
      security: []
      description: |
        Simple health check endpoint for load balancer probes, Docker HEALTHCHECK,
        and Kubernetes liveness/readiness.

        Returns a simple response indicating the service is alive.
        For comprehensive system status with subsystem checks, use `/api/v1/status`.

        No authentication required.
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckSimpleResponse'
              example:
                ok: true
                status: healthy
                timestamp: '2024-01-08T10:30:00Z'
                uptimeSeconds: 3600
                version: 0.1.0
        '429':
          $ref: '#/components/responses/RateLimited'
  /openapi.json:
    get:
      operationId: getOpenApiSpec
      tags:
        - System
      summary: OpenAPI specification
      security: []
      description: |
        Returns the OpenAPI 3.1 specification for the API in JSON format.

        Auto-generated by Elysia from route definitions.

        No authentication required.
      responses:
        '200':
          description: OpenAPI specification
          content:
            application/json:
              schema:
                type: object
                description: OpenAPI 3.1 specification document
        '429':
          $ref: '#/components/responses/RateLimited'
  /docs:
    get:
      operationId: getApiDocs
      tags:
        - System
      summary: API documentation
      security: []
      description: |
        Interactive API documentation (Swagger UI or similar).

        Uses Elysia's `@elysiajs/swagger` plugin.

        No authentication required.
      responses:
        '200':
          description: API documentation page
          content:
            text/html:
              schema:
                type: string
                description: HTML page with interactive API documentation
        '429':
          $ref: '#/components/responses/RateLimited'
  /api/v1/changelog:
    get:
      operationId: getChangelog
      tags:
        - System
      summary: API changelog
      security: []
      description: |
        Returns the API changelog with version history, release dates, and changes.

        Useful for tracking API updates and planning migrations.

        No authentication required.
      responses:
        '200':
          description: API changelog
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChangelogResponse'
              example:
                ok: true
                data:
                  currentVersion: 1.5.2
                  releasedAt: '2025-12-15T00:00:00Z'
                  entries:
                    - version: 1.5.2
                      date: '2025-12-15'
                      changes:
                        - type: added
                          description: Added bulk append endpoint
                        - type: fixed
                          description: Fixed race condition in claim renewal
        '429':
          $ref: '#/components/responses/RateLimited'
  /api/v1/status:
    get:
      operationId: getServiceStatus
      tags:
        - System
      summary: Service status (comprehensive)
      security: []
      description: |
        Returns the current service status for all components.

        Useful for programmatic status checks (e.g., agents deciding whether to retry)
        and status page integration.

        For simple liveness probes, use `/health` instead.

        No authentication required.
      responses:
        '200':
          description: Service status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
              example:
                ok: true
                data:
                  status: operational
                  timestamp: '2026-02-22T19:01:10.304Z'
                  environment: production
                  uptimeSeconds: 86400
                  version: 0.1.0
                  database:
                    status: operational
                    latencyMs: 15
                  storage:
                    status: operational
                    latencyMs: 8
                  websocket:
                    status: operational
                    latencyMs: 31
                    activeConnections: 42
                  regions:
                    - name: us-east-1
                      status: operational
        '429':
          $ref: '#/components/responses/RateLimited'
  /w/{key}/capabilities/check:
    post:
      operationId: checkCapabilitiesInWorkspace
      tags:
        - System
      summary: Check capabilities for URLs in workspace context
      security:
        - capabilityKeyAuth: []
      description: |
        Check the validity of capability URLs with extended information available
        when using a write key.

        Returns extended information about keys belonging to the file/workspace,
        including path and detailed status.

        Keys for other files return minimal response (valid/invalid only).

        **Use cases:**
        - Agent startup: "Which of my configured keys are still valid?"
        - Monitoring: "Have any of our capability URLs been rotated?"
        - File owner audit: "What keys exist for my file and what permissions do they have?"

        **Rate limiting:** 5 requests/min per IP.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CapabilitiesCheckRequest'
            example:
              keys:
                - x8k2mP9qL3nR
                - 3kL9mQ2pN7xR
                - invalidKey123
      responses:
        '200':
          description: Capability check results with extended information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CapabilitiesCheckInWorkspaceResponse'
              example:
                ok: true
                data:
                  results:
                    - key: x8k2mP9q...
                      valid: true
                      permission: read
                      scope: file
                      path: /projects/alpha/tasks.md
                      status: active
                    - key: 3kL9mQ2p...
                      valid: true
                      permission: append
                      scope: file
                      path: /projects/alpha/tasks.md
                      status: active
                    - key: invalidK...
                      valid: false
                      error: NOT_FOUND
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
  /w/{key}/audit:
    get:
      operationId: getAuditLogs
      tags:
        - Admin
      summary: Get audit logs
      security:
        - capabilityKeyAuth: []
      description: |
        Returns audit logs for the workspace. Requires write key.

        Audit logs track all significant actions performed in the workspace,
        including file operations, key management, and webhook changes.

        Supports filtering by action, resource type, actor, and date range.
        Results are paginated with configurable limit and cursor.
      parameters:
        - $ref: '#/components/parameters/capabilityKey'
        - name: action
          in: query
          description: Filter by action type
          schema:
            type: string
            enum:
              - file.create
              - file.update
              - file.delete
              - append
              - claim
              - key.create
              - key.revoke
              - webhook.create
              - webhook.update
              - webhook.delete
              - workspace.claim
        - name: resourceType
          in: query
          description: Filter by resource type
          schema:
            type: string
            enum:
              - file
              - folder
              - key
              - webhook
              - workspace
        - name: actor
          in: query
          description: Filter by actor (key prefix or identifier)
          schema:
            type: string
        - name: since
          in: query
          description: Filter logs from this date (ISO 8601 format)
          schema:
            type: string
            format: date-time
        - name: until
          in: query
          description: Filter logs until this date (ISO 8601 format)
          schema:
            type: string
            format: date-time
        - name: limit
          in: query
          description: Maximum number of logs to return (default 50, max 100)
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
        - name: cursor
          in: query
          description: Cursor for pagination (opaque)
          schema:
            type: string
      responses:
        '200':
          description: Audit logs retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditLogsResponse'
              example:
                ok: true
                data:
                  - id: audit_x8k2mP9qL3nR
                    action: file.create
                    resourceType: file
                    resourceId: file_y9m3n
                    resourcePath: /projects/alpha/tasks.md
                    actor: w_abc...
                    actorType: capability_url
                    metadata: {}
                    createdAt: '2024-01-08T10:30:00Z'
                pagination:
                  total: 150
                  limit: 50
                  cursor: audit_x8k2mP9qL3nR
                  hasMore: true
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
  /api/v1/admin/metrics:
    get:
      operationId: getAdminMetrics
      tags:
        - Admin
      summary: Get system metrics
      description: |
        Returns system-wide metrics including storage usage, entity counts,
        and health indicators.

        **Authentication:** Requires `Authorization: Bearer <ADMIN_SECRET>` header.
        The ADMIN_SECRET is set via environment variable on the server.

        **Security:** This endpoint exposes sensitive operational data.
        Only share the ADMIN_SECRET with trusted operators.
      security:
        - adminToken: []
      responses:
        '200':
          description: System metrics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminMetricsResponse'
              example:
                ok: true
                data:
                  storage:
                    databaseSizeBytes: 52428800
                    databaseSizeMB: 50
                    maxSizeBytes: 5368709120
                    maxSizeMB: 5120
                    usagePercent: 0.98
                  counts:
                    workspaces: 42
                    files: 1250
                    folders: 180
                    users: 15
                    activeSessions: 8
                    capabilityKeys: 126
                  quotas:
                    maxWorkspaceStorageBytes: 104857600
                    maxFileSizeBytes: 10485760
                  uptime:
                    seconds: 86400
                    formatted: 1d 0h 0m
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
components:
  schemas:
    BootstrapRequest:
      type: object
      description: Required configuration for workspace bootstrap
      required:
        - workspaceName
      properties:
        workspaceName:
          type: string
          description: Human-friendly workspace name
          minLength: 1
          maxLength: 255
          pattern: .*\S.*
    BootstrapKeys:
      type: object
      description: Capability keys for the workspace (use these with API or web URLs)
      required:
        - read
        - append
        - write
      properties:
        read:
          type: string
          description: Read capability key - grants read-only access
          example: m7dXp9lKa2nQe4R8vL5wYt
        append:
          type: string
          description: Append capability key - grants read + append access
          example: a_nK3pL9mQ2xR8vL5wYt
        write:
          type: string
          description: Write capability key - grants full access (read + append + write)
          example: w_vT5yU8wX1zA4vL5wYt
    BootstrapApiUrls:
      type: object
      description: API endpoint URLs (for curl/CLI usage)
      required:
        - read
        - append
        - write
      properties:
        read:
          type: string
          format: uri
          description: Read API base URL
          example: https://api.mdplane.dev/r/m7dXp9lKa2nQe4R8vL5wYt
        append:
          type: string
          format: uri
          description: Append API base URL
          example: https://api.mdplane.dev/a/a_nK3pL9mQ2xR8vL5wYt
        write:
          type: string
          format: uri
          description: Write API base URL
          example: https://api.mdplane.dev/w/w_vT5yU8wX1zA4vL5wYt
    BootstrapWebUrls:
      type: object
      description: Web UI URLs (for browser access)
      required:
        - read
        - claim
      properties:
        read:
          type: string
          format: uri
          description: Read-only file browser
          example: https://app.mdplane.dev/r/m7dXp9lKa2nQe4R8vL5wYt
        claim:
          type: string
          format: uri
          description: Claim workspace page (requires login to complete)
          example: https://app.mdplane.dev/claim/w_vT5yU8wX1zA4vL5wYt
    BootstrapUrls:
      type: object
      description: Pre-built URLs for API and web access
      required:
        - api
        - web
      properties:
        api:
          $ref: '#/components/schemas/BootstrapApiUrls'
        web:
          $ref: '#/components/schemas/BootstrapWebUrls'
    BootstrapResponse:
      type: object
      description: Response from bootstrap endpoint with workspace details
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - workspaceId
            - keys
            - urls
            - createdAt
          properties:
            workspaceId:
              type: string
              description: Unique workspace identifier
              pattern: ^ws_[A-Za-z0-9]{12,}$
              example: ws_x8k2mP9qL3nR
            keys:
              $ref: '#/components/schemas/BootstrapKeys'
            urls:
              $ref: '#/components/schemas/BootstrapUrls'
            createdAt:
              type: string
              format: date-time
              description: Workspace creation timestamp
    Error:
      type: object
      required:
        - ok
        - error
      properties:
        ok:
          type: boolean
          const: false
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: Machine-readable error code
              enum:
                - FILE_NOT_FOUND
                - FOLDER_NOT_FOUND
                - FOLDER_ALREADY_EXISTS
                - FOLDER_EXISTS
                - SOURCE_NOT_FOUND
                - APPEND_NOT_FOUND
                - WEBHOOK_NOT_FOUND
                - WORKSPACE_NOT_FOUND
                - FILE_DELETED
                - FILE_ALREADY_EXISTS
                - FOLDER_NOT_EMPTY
                - INVALID_REQUEST
                - SERVER_ERROR
                - INVALID_APPEND_TYPE
                - INVALID_REF
                - INVALID_VOTE_VALUE
                - INVALID_AUTHOR
                - INVALID_TOKEN
                - INVALID_WEBHOOK_URL
                - INVALID_PATH
                - INVALID_CONTENT
                - INVALID_TARGET
                - INVALID_KEY
                - INVALID_FILENAME
                - INVALID_APPEND_ID
                - SECTION_NOT_FOUND
                - UNSUPPORTED_MEDIA_TYPE
                - TASK_ALREADY_COMPLETE
                - TASK_CANCELLED
                - CLAIM_EXPIRED
                - ALREADY_CLAIMED
                - AUTHOR_MISMATCH
                - CANNOT_RENEW_OTHERS_CLAIM
                - CANNOT_CANCEL_OTHERS_CLAIM
                - TYPE_NOT_ALLOWED
                - KEY_EXPIRED
                - KEY_REVOKED
                - KEY_NOT_FOUND
                - NOT_FOUND
                - PERMISSION_DENIED
                - FORBIDDEN
                - NOT_ASSIGNED
                - CONFLICT
                - PAYLOAD_TOO_LARGE
                - WORKSPACE_TOO_LARGE
                - QUOTA_EXCEEDED
                - RATE_LIMITED
                - WIP_LIMIT_EXCEEDED
                - AUTHOR_RATE_LIMITED
                - BULK_LIMIT_EXCEEDED
                - WEBHOOK_LIMIT_EXCEEDED
                - WEBHOOK_SUSPENDED
                - UNAUTHORIZED
                - CONFIRM_PATH_MISMATCH
                - JOB_NOT_FOUND
                - JOB_NOT_READY
                - INVALID_PATTERN
                - QUERY_TOO_LONG
                - QUERY_TOO_BROAD
                - INVALID_TIMEOUT
                - SCOPE_DENIED
            message:
              type: string
              description: Human-readable error message
            details:
              type: object
              additionalProperties: true
              description: Additional error context
    UserAppendType:
      type: string
      description: User-facing append types that can be created via API or CLI
      enum:
        - task
        - claim
        - response
        - comment
        - blocked
        - answer
        - renew
        - cancel
        - vote
    SystemAppendType:
      type: string
      description: System-only append types (heartbeat, etc.) - not user-creatable
      enum:
        - heartbeat
    AppendType:
      description: All possible append types (user + system)
      oneOf:
        - $ref: '#/components/schemas/UserAppendType'
        - $ref: '#/components/schemas/SystemAppendType'
    AppendStatus:
      type: string
      description: Computed status of a task or claim
      enum:
        - pending
        - open
        - claimed
        - completed
        - done
        - expired
        - cancelled
        - active
    Priority:
      type: string
      description: Task priority level
      enum:
        - low
        - medium
        - high
        - critical
    Append:
      type: object
      description: Full append object returned in parsed file responses
      required:
        - id
        - author
        - ts
        - type
      properties:
        id:
          type: string
          description: Append ID (sequential per-file)
          pattern: ^a[0-9]+$
          example: a1
        author:
          type: string
          description: Author identifier
          pattern: ^[a-zA-Z0-9_-]{1,64}$
          example: jordan
        ts:
          type: string
          format: date-time
          description: ISO 8601 timestamp when append was created
        type:
          $ref: '#/components/schemas/AppendType'
        status:
          $ref: '#/components/schemas/AppendStatus'
        content:
          type: string
          description: Append content (markdown)
        priority:
          $ref: '#/components/schemas/Priority'
        labels:
          type: array
          items:
            type: string
          description: Labels array (tasks only)
        ref:
          type: string
          description: Referenced append ID
          pattern: ^a[0-9]+$
        expiresAt:
          type: string
          format: date-time
          description: Claim expiry timestamp (claims only)
        dueAt:
          type: string
          format: date-time
          description: Due date for tasks
        claimedBy:
          type: string
          description: Current claim holder (tasks only, if claimed)
          pattern: ^[a-zA-Z0-9_-]{1,64}$
        completedAt:
          type: string
          format: date-time
          description: Completion timestamp (tasks only, if completed)
        value:
          type: string
          description: Vote value (votes only)
          enum:
            - '+1'
            - '-1'
        relatedTo:
          type: array
          items:
            type: string
            pattern: ^a[0-9]+$
          description: Informational linkage to other append IDs
        stale:
          type: boolean
          description: True if content hash changed since append was created
    TaskStats:
      type: object
      properties:
        pending:
          type: integer
          description: Number of pending tasks
        claimed:
          type: integer
          description: Number of claimed tasks
        completed:
          type: integer
          description: Number of completed tasks
        activeClaims:
          type: integer
          description: Number of currently active claims
    FileStats:
      type: object
      properties:
        appendCount:
          type: integer
          description: Total number of appends
        taskStats:
          $ref: '#/components/schemas/TaskStats'
    WorkspaceContext:
      type: object
      description: Workspace metadata included in capability URL responses
      required:
        - id
        - claimed
      properties:
        id:
          type: string
          pattern: ^ws_[A-Za-z0-9_]{12,}$
          description: Workspace ID
        name:
          type: string
          description: Workspace name (if set)
        claimed:
          type: boolean
          description: Whether workspace has been claimed by a user
    FileReadResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - id
            - filename
            - content
            - etag
            - createdAt
            - updatedAt
            - appendCount
            - size
          properties:
            id:
              type: string
              description: File ID
            filename:
              type: string
              description: File name
            content:
              type: string
              description: File content (markdown)
            etag:
              type: string
              description: Content version hash for optimistic concurrency
            createdAt:
              type: string
              format: date-time
              description: File creation timestamp
            updatedAt:
              type: string
              format: date-time
              description: Last modification timestamp
            appendCount:
              type: integer
              description: Total number of appends
            size:
              type: integer
              description: File size in bytes
            frontmatter:
              type: object
              additionalProperties: true
              description: Parsed YAML frontmatter (when format=parsed)
            appends:
              type: array
              items:
                $ref: '#/components/schemas/Append'
              description: Parsed appends (when format=parsed or appends param specified)
            stats:
              $ref: '#/components/schemas/FileStats'
            webUrl:
              type: string
              format: uri
              description: URL to view this file in the web app
            workspace:
              $ref: '#/components/schemas/WorkspaceContext'
              description: Workspace context for capability URL UI
    FileUpdateRequest:
      type: object
      required:
        - content
      properties:
        content:
          type: string
          description: New file content (replaces everything)
    FileUpdateResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - id
            - etag
            - updatedAt
            - size
          properties:
            id:
              type: string
              description: File ID
            etag:
              type: string
              description: New content version hash
            updatedAt:
              type: string
              format: date-time
              description: New modification timestamp
            size:
              type: integer
              description: New file size in bytes
            appendsStale:
              type: integer
              description: Number of appends marked stale after content replacement
            webUrl:
              type: string
              format: uri
              description: URL to view this file in the web app
    FileDeleteResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - id
            - deleted
          properties:
            id:
              type: string
              description: File ID
            deleted:
              type: boolean
              const: true
            recoverable:
              type: boolean
              description: Whether file can be recovered (soft delete)
            expiresAt:
              type: string
              format: date-time
              description: When soft-deleted file will be permanently deleted
    FileRenameRequest:
      type: object
      required:
        - filename
      properties:
        filename:
          type: string
          description: New filename
          maxLength: 255
    FileRenameResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - id
            - filename
          properties:
            id:
              type: string
              description: File ID
            filename:
              type: string
              description: New filename after rename
    FileMetaResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - id
            - filename
            - folder
            - size
            - createdAt
            - updatedAt
            - appendCount
            - taskStats
            - hasWebhook
          properties:
            id:
              type: string
              description: File ID
            filename:
              type: string
              description: File name
            folder:
              type: string
              description: Parent folder path
            size:
              type: integer
              description: File size in bytes
            createdAt:
              type: string
              format: date-time
              description: File creation timestamp
            updatedAt:
              type: string
              format: date-time
              description: Last modification timestamp
            appendCount:
              type: integer
              description: Total number of appends
            taskStats:
              $ref: '#/components/schemas/TaskStats'
            hasWebhook:
              type: boolean
              description: Whether file has active webhooks
            webUrl:
              type: string
              format: uri
              description: URL to view this file in the web app
    FileTailResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - content
            - bytesReturned
            - truncated
          properties:
            content:
              type: string
              description: Tail content (last N bytes/lines)
            bytesReturned:
              type: integer
              description: Number of bytes returned
            truncated:
              type: boolean
              description: Whether content was truncated (file larger than requested)
    FileStructureResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - headings
            - appendCount
            - hasTaskAppends
          properties:
            headings:
              type: array
              items:
                type: object
                required:
                  - level
                  - text
                  - line
                properties:
                  level:
                    type: integer
                    minimum: 1
                    maximum: 6
                    description: Heading level (1-6)
                  text:
                    type: string
                    description: Heading text content
                  line:
                    type: integer
                    minimum: 1
                    description: Line number in file
            appendCount:
              type: integer
              description: Total number of appends in the file
            hasTaskAppends:
              type: boolean
              description: Whether file has any task appends
    FileSectionResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - heading
            - level
            - content
            - startLine
            - endLine
          properties:
            heading:
              type: string
              description: Heading text that was matched
            level:
              type: integer
              minimum: 1
              maximum: 6
              description: Heading level (1-6)
            content:
              type: string
              description: Section content
            startLine:
              type: integer
              minimum: 1
              description: Starting line number
            endLine:
              type: integer
              minimum: 1
              description: Ending line number
    AppendGetResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          $ref: '#/components/schemas/Append'
    CapabilityUrls:
      type: object
      required:
        - read
        - append
        - write
      description: |
        Capability URLs for different permission levels.
        URL fields are nullable - null indicates the current key lacks permission for that tier.
      properties:
        read:
          type:
            - string
            - 'null'
          format: uri
          description: Read-only capability URL (null if key lacks read permission)
        append:
          type:
            - string
            - 'null'
          format: uri
          description: Append capability URL (null if key lacks append permission)
        write:
          type:
            - string
            - 'null'
          format: uri
          description: Admin/write capability URL (null if key lacks write permission)
    FileRecoverResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - id
            - recovered
            - path
            - urls
          properties:
            id:
              type: string
              description: File ID
            recovered:
              type: boolean
              const: true
            path:
              type: string
              description: File path after recovery
            urls:
              $ref: '#/components/schemas/CapabilityUrls'
            webUrl:
              type: string
              format: uri
              description: URL to view this file in the web app
    FileMoveRequest:
      type: object
      required:
        - source
        - destination
      properties:
        source:
          type: string
          description: Source file path (absolute from workspace root)
        destination:
          type: string
          description: Destination folder path (absolute from workspace root)
    FileMoveResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - id
            - previousPath
            - newPath
          properties:
            id:
              type: string
              description: File ID
            previousPath:
              type: string
              description: Original file path
            newPath:
              type: string
              description: New file path after move
            webUrl:
              type: string
              format: uri
              description: URL to view this file in the web app at the new path
    FileRotateUrlsResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - id
            - urls
            - previousUrlsInvalidated
          properties:
            id:
              type: string
              description: File ID
            urls:
              $ref: '#/components/schemas/CapabilityUrls'
            previousUrlsInvalidated:
              type: boolean
              const: true
            webUrl:
              type: string
              format: uri
              description: URL to view this file in the web app
    FileSettings:
      type: object
      properties:
        claimDurationSeconds:
          type: integer
          minimum: 60
          description: Default claim duration in seconds
        maxAppendSize:
          type: integer
          minimum: 1
          maximum: 1048576
          description: Maximum append size in bytes
        allowedAppendTypes:
          type: array
          items:
            $ref: '#/components/schemas/UserAppendType'
          description: Allowed append types for this file
        wipLimit:
          type: integer
          minimum: 1
          description: Work-in-progress limit for claims
        labels:
          type: array
          items:
            type: string
          description: Allowed labels for this file
    FileSettingsResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          $ref: '#/components/schemas/FileSettings'
    FileSettingsUpdateRequest:
      type: object
      description: Partial update for file settings
      properties:
        claimDurationSeconds:
          type: integer
          minimum: 60
          description: Default claim duration in seconds
        maxAppendSize:
          type: integer
          minimum: 1
          maximum: 1048576
          description: Maximum append size in bytes
        allowedAppendTypes:
          type: array
          items:
            $ref: '#/components/schemas/UserAppendType'
          description: Allowed append types for this file
        wipLimit:
          type: integer
          minimum: 1
          description: Work-in-progress limit for claims
        labels:
          type: array
          items:
            type: string
          description: Allowed labels for this file
    AppendRequest:
      type: object
      description: Request body for creating a single append
      required:
        - type
      properties:
        path:
          type: string
          description: |
            Target file path for append operations that do not derive file scope from the key.
            Required for workspace-scoped and folder-scoped keys when using `/a/{key}/append`.
        author:
          type: string
          description: Author identifier (required for root keys)
          pattern: ^[a-zA-Z0-9_-]{1,64}$
        type:
          $ref: '#/components/schemas/UserAppendType'
        content:
          type: string
          description: Append content
        ref:
          type: string
          description: Referenced append ID (required for claim, response, blocked, answer, renew, cancel, vote)
          pattern: ^a[0-9]+$
        priority:
          $ref: '#/components/schemas/Priority'
        labels:
          type: array
          items:
            type: string
          description: Labels (tasks only)
        dueAt:
          type: string
          format: date-time
          description: Due date (tasks only)
        assigned:
          type: string
          description: Assigned author (tasks only)
          pattern: ^[a-zA-Z0-9_-]{1,64}$
        value:
          type: string
          description: Vote value (votes only)
          enum:
            - '+1'
            - '-1'
        relatedTo:
          type: array
          items:
            type: string
            pattern: ^a[0-9]+$
          description: Informational linkage to other append IDs
        expiresInSeconds:
          type: integer
          minimum: 60
          maximum: 86400
          description: Custom claim expiry in seconds (claims only, default 1800)
    AppendItem:
      type: object
      description: Single append item for atomic multi-append (author inherited from parent)
      required:
        - type
      properties:
        type:
          $ref: '#/components/schemas/UserAppendType'
        content:
          type: string
          description: Append content
        ref:
          type: string
          description: Referenced append ID
          pattern: ^a[0-9]+$
        priority:
          $ref: '#/components/schemas/Priority'
        labels:
          type: array
          items:
            type: string
        dueAt:
          type: string
          format: date-time
        assigned:
          type: string
          pattern: ^[a-zA-Z0-9_-]{1,64}$
        value:
          type: string
          enum:
            - '+1'
            - '-1'
        relatedTo:
          type: array
          items:
            type: string
            pattern: ^a[0-9]+$
        expiresInSeconds:
          type: integer
          minimum: 60
          maximum: 86400
          description: Custom claim expiry in seconds (claims only, default 1800)
    MultiAppendRequest:
      type: object
      description: Request body for atomic multi-append operation
      required:
        - author
        - appends
      properties:
        path:
          type: string
          description: |
            Target file path for append operations that do not derive file scope from the key.
            Required for workspace-scoped and folder-scoped keys when using `/a/{key}/append`.
        author:
          type: string
          description: Author for all appends in this request
          pattern: ^[a-zA-Z0-9_-]{1,64}$
        appends:
          type: array
          description: Array of append items (max 100)
          maxItems: 100
          items:
            $ref: '#/components/schemas/AppendItem'
    SingleAppendResult:
      type: object
      description: Result of a single append operation
      required:
        - id
        - author
        - ts
        - type
      properties:
        id:
          type: string
          pattern: ^a[0-9]+$
        author:
          type: string
          pattern: ^[a-zA-Z0-9_-]{1,64}$
        ts:
          type: string
          format: date-time
        type:
          $ref: '#/components/schemas/AppendType'
        ref:
          type: string
          pattern: ^a[0-9]+$
        expiresAt:
          type: string
          format: date-time
          description: Claim expiry timestamp (for claim type)
        expiresInSeconds:
          type: integer
          description: Seconds until claim expires
        status:
          $ref: '#/components/schemas/AppendStatus'
          description: Initial status (e.g., 'open' for tasks)
        priority:
          $ref: '#/components/schemas/Priority'
          description: Task priority level (tasks only)
        labels:
          type: array
          items:
            type: string
          description: Labels array (tasks only)
        dueAt:
          type: string
          format: date-time
          description: Due date (tasks only)
        taskStatus:
          type: string
          description: Updated task status after operation (for response/cancel)
          enum:
            - open
            - done
        value:
          type: string
          description: Vote value (votes only)
          enum:
            - '+1'
            - '-1'
    MultiAppendResult:
      type: object
      description: Result of atomic multi-append operation
      required:
        - appends
      properties:
        appends:
          type: array
          items:
            type: object
            required:
              - id
              - type
            properties:
              id:
                type: string
                pattern: ^a[0-9]+$
              type:
                $ref: '#/components/schemas/AppendType'
              ref:
                type: string
                pattern: ^a[0-9]+$
              expiresAt:
                type: string
                format: date-time
                description: Claim expiry timestamp (for claim type)
              expiresInSeconds:
                type: integer
                description: Seconds until claim expires
    AppendResponse:
      type: object
      description: Response for append operations
      required:
        - ok
        - serverTime
        - data
      properties:
        ok:
          type: boolean
          const: true
        serverTime:
          type: string
          format: date-time
          description: Server timestamp for synchronization
        data:
          oneOf:
            - $ref: '#/components/schemas/SingleAppendResult'
            - $ref: '#/components/schemas/MultiAppendResult'
        webUrl:
          type: string
          format: uri
          description: URL to view this file in the web app
    ScopedAppendRequest:
      type: object
      description: Request body for scoped path-based append
      properties:
        author:
          type: string
          description: Author identifier (may be enforced by boundAuthor on key)
          pattern: ^[a-zA-Z0-9_-]{1,64}$
        type:
          type: string
          description: Append type (may be restricted by allowedTypes on key)
        content:
          type: string
          description: Append content
    ScopedAppendResult:
      type: object
      description: Result of a scoped append operation
      required:
        - appendId
        - createdAt
      properties:
        appendId:
          type: string
          description: Append ID
          pattern: ^a[0-9]+$
        type:
          type: string
          description: Append type (if provided)
        author:
          type: string
          description: Author identifier
          pattern: ^[a-zA-Z0-9_-]{1,64}$
        createdAt:
          type: string
          format: date-time
          description: ISO 8601 timestamp when append was created
    ScopedAppendResponse:
      type: object
      description: Response for scoped path-based append operations
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          $ref: '#/components/schemas/ScopedAppendResult'
    FolderItemType:
      type: string
      description: Type of item in folder listing
      enum:
        - file
        - folder
    FolderItem:
      type: object
      description: An item in a folder listing (file or subfolder)
      required:
        - name
        - type
      properties:
        name:
          type: string
          description: Item name (filename or folder name)
        type:
          $ref: '#/components/schemas/FolderItemType'
        size:
          type: integer
          description: File size in bytes (files only)
        updatedAt:
          type: string
          format: date-time
          description: Last modification timestamp
        appendCount:
          type: integer
          description: Number of appends (files only)
        childCount:
          type: integer
          description: Number of child items (folders only)
        urls:
          $ref: '#/components/schemas/CapabilityUrls'
        items:
          type: array
          description: Nested items when depth > 1 (folders only)
          items:
            $ref: '#/components/schemas/FolderItem'
    PaginatedResponse:
      type: object
      properties:
        cursor:
          type: string
          description: Opaque cursor for next page
        hasMore:
          type: boolean
          description: Whether more results are available
        total:
          type: integer
          description: Total count of items (when available)
    FolderListResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - path
            - items
          properties:
            path:
              type: string
              description: Folder path
            items:
              type: array
              items:
                $ref: '#/components/schemas/FolderItem'
            webUrl:
              type: string
              format: uri
              description: URL to view this folder in the web interface
            workspace:
              $ref: '#/components/schemas/WorkspaceContext'
              description: Workspace context for capability URL UI
        pagination:
          $ref: '#/components/schemas/PaginatedResponse'
    CreateFileRequest:
      type: object
      required:
        - filename
      properties:
        filename:
          type: string
          description: File name
          maxLength: 255
        content:
          type: string
          description: Initial file content
    CreateFileResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - id
            - filename
            - path
            - urls
            - createdAt
          properties:
            id:
              type: string
              description: File ID
            filename:
              type: string
              description: File name
            path:
              type: string
              description: Full file path
            urls:
              $ref: '#/components/schemas/CapabilityUrls'
            createdAt:
              type: string
              format: date-time
              description: Creation timestamp
            webUrl:
              type: string
              format: uri
              description: URL to view this file in the web interface
    FolderDeleteRequest:
      type: object
      description: Request body for cascade delete of non-empty folders
      properties:
        cascade:
          type: boolean
          description: Delete folder and all contents
        confirmPath:
          type: string
          description: Must match folder path exactly (without leading slash)
    FolderDeleteResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - deleted
            - path
          properties:
            deleted:
              type: boolean
              const: true
            path:
              type: string
              description: Deleted folder path
            filesDeleted:
              type: integer
              description: Number of files deleted (cascade only)
            foldersDeleted:
              type: integer
              description: Number of subfolders deleted (cascade only)
            recoverable:
              type: boolean
              description: Whether deleted content can be recovered
            expiresAt:
              type: string
              format: date-time
              description: When soft-deleted content will be permanently deleted
    FolderRenameRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: New folder name
          maxLength: 255
    FolderMoveResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - previousPath
            - newPath
          properties:
            previousPath:
              type: string
              description: Original folder path
            newPath:
              type: string
              description: New folder path after move
            filesUpdated:
              type: integer
              description: Number of files affected by the move
            webUrl:
              type: string
              format: uri
              description: URL to view this folder in the web interface at the new path
    FolderCreateRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: New folder name
          maxLength: 255
        path:
          type: string
          description: Parent folder path (defaults to root)
    FolderCreateResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - path
            - urls
            - createdAt
          properties:
            path:
              type: string
              description: Full path of created folder
            urls:
              $ref: '#/components/schemas/CapabilityUrls'
            createdAt:
              type: string
              format: date-time
              description: Creation timestamp
            webUrl:
              type: string
              format: uri
              description: URL to view this folder in the web interface
    CopyFileToFolderRequest:
      type: object
      description: Request body for copying a file into a folder
      required:
        - sourceKey
      properties:
        sourceKey:
          type: string
          description: Read key of the source file to copy
        filename:
          type: string
          description: Optional new filename (defaults to source filename)
    FolderBulkCreateItem:
      type: object
      description: Single file to create in bulk operation
      required:
        - filename
      properties:
        filename:
          type: string
          description: File name
          maxLength: 255
        content:
          type: string
          description: Initial file content
    FolderBulkCreateRequest:
      type: object
      description: Request body for bulk file creation
      required:
        - files
      properties:
        files:
          type: array
          description: Array of files to create (max 100)
          maxItems: 100
          items:
            $ref: '#/components/schemas/FolderBulkCreateItem'
    FolderBulkCreateResultItem:
      type: object
      description: Result for a single file in bulk create
      required:
        - filename
        - id
        - urls
      properties:
        filename:
          type: string
        id:
          type: string
        urls:
          $ref: '#/components/schemas/CapabilityUrls'
        webUrl:
          type: string
          format: uri
          description: URL to view this file in the web interface
    FolderBulkCreateResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - created
          properties:
            created:
              type: array
              items:
                $ref: '#/components/schemas/FolderBulkCreateResultItem'
            webUrl:
              type: string
              format: uri
              description: URL to view the parent folder in the web interface
    FolderBulkCreateJobResponse:
      type: object
      description: Response for async bulk file creation (202 Accepted)
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - jobId
          properties:
            jobId:
              type: string
              description: Job ID for polling status
    FolderMoveRequest:
      type: object
      required:
        - destination
      properties:
        destination:
          type: string
          description: Destination folder path
    FolderSettings:
      type: object
      description: Folder-level settings
      properties:
        inheritSettings:
          type: boolean
          description: Whether to inherit settings from parent folder
        defaultLabels:
          type: array
          items:
            type: string
          description: Default labels for files created in this folder
        allowedTypes:
          type: array
          items:
            type: string
            enum:
              - task
              - claim
              - response
              - comment
              - blocked
              - answer
              - renew
              - cancel
              - vote
          description: Allowed append types for files in this folder
    FolderSettingsResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          $ref: '#/components/schemas/FolderSettings'
    FolderSettingsUpdateRequest:
      type: object
      description: Partial update for folder settings
      properties:
        inheritSettings:
          type: boolean
          description: Whether to inherit settings from parent folder
        defaultLabels:
          type: array
          items:
            type: string
          description: Default labels for files created in this folder
        allowedTypes:
          type: array
          items:
            type: string
            enum:
              - task
              - claim
              - response
              - comment
              - blocked
              - answer
              - renew
              - cancel
              - vote
          description: Allowed append types for files in this folder
    FolderStatsResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - path
            - fileCount
            - folderCount
            - totalSize
          properties:
            path:
              type: string
              description: Folder path
            fileCount:
              type: integer
              description: Total number of files
            folderCount:
              type: integer
              description: Total number of subfolders
            totalSize:
              type: integer
              description: Total size in bytes
            updatedAt:
              type: string
              format: date-time
              description: Most recent modification timestamp
            taskStats:
              $ref: '#/components/schemas/TaskStats'
    FileReference:
      type: object
      description: Reference to a file with ID and path
      required:
        - id
        - path
      properties:
        id:
          type: string
          description: Unique file identifier
        path:
          type: string
          description: File path relative to workspace root
    FileUrls:
      type: object
      description: Capability URLs for file access (only includes URLs the key has access to)
      properties:
        read:
          type: string
          format: uri
          description: Read-only capability URL
        append:
          type: string
          format: uri
          description: Append capability URL
        write:
          type: string
          format: uri
          description: Admin/write capability URL
    FolderSearchMatch:
      type: object
      description: Single match within a file for folder search
      required:
        - appendId
        - type
        - content
      properties:
        appendId:
          type: string
          description: Unique append identifier
        type:
          type: string
          description: Type of append (task, comment, etc.)
        content:
          type: string
          description: Content snippet matching the search query
        priority:
          type: string
          description: Priority level (if applicable)
        status:
          type: string
          description: Status (if applicable)
        labels:
          type: array
          items:
            type: string
          description: Labels attached to this append
        author:
          type: string
          description: Author of the append
        createdAt:
          type: string
          format: date-time
          description: Creation timestamp
    FolderSearchResult:
      type: object
      description: Search results grouped by file
      required:
        - file
      properties:
        file:
          $ref: '#/components/schemas/FileReference'
        fileUrls:
          $ref: '#/components/schemas/FileUrls'
        matches:
          type: array
          items:
            $ref: '#/components/schemas/FolderSearchMatch'
    FolderSearchResponse:
      type: object
      description: Response from folder search endpoint
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - results
          properties:
            results:
              type: array
              items:
                $ref: '#/components/schemas/FolderSearchResult'
            truncated:
              type: boolean
              description: Whether search was truncated due to timeout
        pagination:
          $ref: '#/components/schemas/PaginatedResponse'
    TaskQueryResult:
      type: object
      description: Task result from task query endpoint
      required:
        - id
        - file
        - content
        - status
        - createdAt
      properties:
        id:
          type: string
          description: Append ID of the task
        file:
          $ref: '#/components/schemas/FileReference'
        fileUrls:
          $ref: '#/components/schemas/FileUrls'
        content:
          type: string
          description: Task content
        author:
          type: string
          description: Task author
        status:
          type: string
          description: Task status
          enum:
            - pending
            - claimed
            - completed
            - cancelled
        priority:
          type: string
          description: Task priority
          enum:
            - low
            - medium
            - high
            - critical
        labels:
          type: array
          items:
            type: string
          description: Labels attached to this task
        claimedBy:
          type: string
          description: User who claimed the task (if claimed)
        expiresAt:
          type: string
          format: date-time
          description: Claim expiration time (if claimed)
        createdAt:
          type: string
          format: date-time
          description: Task creation timestamp
    TaskSummary:
      type: object
      description: Summary counts of tasks by status
      required:
        - pending
        - claimed
        - completed
      properties:
        pending:
          type: integer
          description: Count of pending tasks
        claimed:
          type: integer
          description: Count of claimed tasks
        completed:
          type: integer
          description: Count of completed tasks
    TaskQueryResponse:
      type: object
      description: Response from task query endpoint
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - tasks
            - summary
            - webUrl
          properties:
            tasks:
              type: array
              items:
                $ref: '#/components/schemas/TaskQueryResult'
            summary:
              $ref: '#/components/schemas/TaskSummary'
            webUrl:
              type: string
              format: uri
              description: URL to view tasks in the web interface
        pagination:
          $ref: '#/components/schemas/PaginatedResponse'
    WebhookEvent:
      type: string
      description: Event types that can trigger webhooks
      enum:
        - append
        - append.created
        - task.created
        - task.claimed
        - task.completed
        - task.cancelled
        - task.blocked
        - task.unblocked
        - task.overdue
        - task.escalated
        - task.recurred
        - task.expired
        - claim.created
        - claim.expired
        - claim.renewed
        - claim.released
        - file.created
        - file.updated
        - file.deleted
        - heartbeat
        - webhook.failed
        - settings.changed
    WebhookStatus:
      type: string
      description: Webhook status
      enum:
        - active
        - paused
        - suspended
        - disabled
    Webhook:
      type: object
      description: Webhook configuration
      required:
        - id
        - url
        - events
        - status
        - createdAt
      properties:
        id:
          type: string
          description: Webhook ID
        url:
          type: string
          format: uri
          description: Webhook URL
        events:
          type: array
          items:
            $ref: '#/components/schemas/WebhookEvent'
        status:
          $ref: '#/components/schemas/WebhookStatus'
        includeUrls:
          type: boolean
          description: Whether capability URLs are included in payloads
        createdAt:
          type: string
          format: date-time
          description: Creation timestamp
        lastTriggeredAt:
          type: string
          format: date-time
          description: Last successful delivery timestamp
        failureCount:
          type: integer
          description: Consecutive failure count
        successRate:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Success rate (0.0 to 1.0)
    WebhookListResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: array
          items:
            $ref: '#/components/schemas/Webhook'
        webUrl:
          type: string
          format: uri
          description: URL to manage webhooks in the web interface
    WebhookCreateRequest:
      type: object
      description: Request to register a new webhook
      required:
        - url
        - events
      properties:
        url:
          type: string
          format: uri
          description: HTTPS URL to receive webhook payloads
        events:
          type: array
          items:
            $ref: '#/components/schemas/WebhookEvent'
          description: Events to subscribe to
        secret:
          type: string
          minLength: 32
          description: HMAC-SHA256 signing secret (min 32 chars). If omitted, server generates one.
        headers:
          type: object
          additionalProperties:
            type: string
          description: Custom headers to include in webhook requests
        includeUrls:
          type: boolean
          default: true
          description: Whether to include capability URLs in payloads
        filters:
          type: object
          description: Optional filters to narrow which events trigger the webhook
          properties:
            types:
              type: array
              items:
                type: string
              description: Filter by append types
            labels:
              type: array
              items:
                type: string
              description: Filter by labels
            priority:
              type: array
              items:
                type: string
              description: Filter by priority levels
        recursive:
          type: boolean
          description: Whether the webhook should trigger for changes in subfolders (folder webhooks only)
    WebhookCreateResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - id
            - url
            - events
            - status
            - createdAt
          properties:
            id:
              type: string
              description: Webhook ID
            url:
              type: string
              format: uri
              description: Webhook URL
            events:
              type: array
              items:
                $ref: '#/components/schemas/WebhookEvent'
            status:
              $ref: '#/components/schemas/WebhookStatus'
            secret:
              type: string
              description: Generated secret (only returned once at creation if not provided)
            includeUrls:
              type: boolean
            createdAt:
              type: string
              format: date-time
              description: Creation timestamp
            webUrl:
              type: string
              format: uri
              description: URL to manage webhooks in the web interface
    WebhookDeleteResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - id
            - deleted
          properties:
            id:
              type: string
              description: Deleted webhook ID
            deleted:
              type: boolean
              const: true
    WebhookUpdateRequest:
      type: object
      description: Partial update for webhook configuration
      properties:
        url:
          type: string
          format: uri
          description: New webhook URL
        events:
          type: array
          items:
            $ref: '#/components/schemas/WebhookEvent'
          description: Updated event subscriptions
        active:
          type: boolean
          description: Enable/disable webhook
        secret:
          type: string
          minLength: 32
          description: New signing secret
        headers:
          type: object
          additionalProperties:
            type: string
          description: Updated custom headers
        includeUrls:
          type: boolean
          description: Whether to include capability URLs in payloads
        filters:
          type: object
          description: Updated filters
          properties:
            types:
              type: array
              items:
                type: string
            labels:
              type: array
              items:
                type: string
            priority:
              type: array
              items:
                type: string
        recursive:
          type: boolean
          description: Whether the webhook should trigger for changes in subfolders (folder webhooks only)
    WebhookUpdateResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          $ref: '#/components/schemas/Webhook'
    FolderClaimFileInfo:
      type: object
      description: File information for a claim
      required:
        - id
        - path
      properties:
        id:
          type: string
          description: File ID
        path:
          type: string
          description: File path within folder
    FolderClaimItem:
      type: object
      description: A single claim in a folder
      required:
        - taskId
        - claimId
        - file
        - taskContent
        - status
        - expiresAt
        - expiresInSeconds
      properties:
        taskId:
          type: string
          description: ID of the claimed task
        claimId:
          type: string
          description: ID of the claim append
        file:
          $ref: '#/components/schemas/FolderClaimFileInfo'
        taskContent:
          type: string
          description: Content of the claimed task
        status:
          type: string
          enum:
            - active
            - expired
          description: Claim status
        expiresAt:
          type: string
          format: date-time
          description: Claim expiry timestamp
        expiresInSeconds:
          type: integer
          description: Seconds until claim expires
    FolderClaimsResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - claims
            - count
            - webUrl
          properties:
            claims:
              type: array
              items:
                $ref: '#/components/schemas/FolderClaimItem'
            count:
              type: integer
              description: Total number of claims
            webUrl:
              type: string
              format: uri
              description: URL to view claims in the web interface
    KeyPermission:
      type: string
      description: Permission level for scoped keys
      enum:
        - read
        - append
        - write
    ScopedKey:
      type: object
      description: Scoped key metadata (key itself is partially redacted)
      required:
        - id
        - permission
        - createdAt
      properties:
        id:
          type: string
          description: Key ID for management operations
        key:
          type: string
          description: Partially visible key (e.g., "a_x8k2...nR")
        permission:
          $ref: '#/components/schemas/KeyPermission'
        boundAuthor:
          type: string
          description: Bound author if set
        displayName:
          type: string
          description: Human-readable name
        wipLimit:
          type: integer
          description: WIP limit for this key
        allowedTypes:
          type: array
          items:
            type: string
          description: Allowed append types
        createdAt:
          type: string
          format: date-time
          description: Key creation timestamp
        expiresAt:
          type: string
          format: date-time
          description: Expiration timestamp if set
        lastUsedAt:
          type: string
          format: date-time
          description: Last usage timestamp
        revoked:
          type: boolean
          description: Whether key has been revoked
    ScopedKeyListResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: array
          items:
            $ref: '#/components/schemas/ScopedKey'
        webUrl:
          type: string
          format: uri
          description: URL to manage API keys in the web interface
    ScopedKeyCreateRequest:
      type: object
      description: Request to create a scoped capability key
      required:
        - permission
      properties:
        permission:
          $ref: '#/components/schemas/KeyPermission'
        boundAuthor:
          type: string
          description: If set, all appends must use this author name
          pattern: ^[a-zA-Z0-9_-]{1,64}$
        displayName:
          type: string
          description: Human-readable name for the key (e.g., "Alpha Research Agent")
          maxLength: 64
        wipLimit:
          type: integer
          minimum: 1
          description: Override WIP limit for this key
        allowedTypes:
          type: array
          items:
            type: string
            enum:
              - task
              - claim
              - response
              - comment
              - blocked
              - answer
              - renew
              - cancel
              - vote
          description: Restrict which append types this key can create
        expiresAt:
          type: string
          format: date-time
          description: Key expiration timestamp
        paths:
          type: array
          items:
            type: string
          description: Restrict key to specific paths
    ScopedKeyCreateResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - id
            - key
            - permission
            - createdAt
          properties:
            id:
              type: string
              description: Unique identifier for the key (used for revocation)
            key:
              type: string
              description: The scoped capability key (prefixed with r_/a_/w_)
              pattern: ^(r|a|w)_[A-Za-z0-9]{20,}$
            permission:
              $ref: '#/components/schemas/KeyPermission'
            boundAuthor:
              type: string
              description: Bound author if set
            displayName:
              type: string
              description: Human-readable name
            wipLimit:
              type: integer
              description: WIP limit for this key
            allowedTypes:
              type: array
              items:
                type: string
              description: Allowed append types
            expiresAt:
              type: string
              format: date-time
              description: Expiration timestamp if set
            createdAt:
              type: string
              format: date-time
              description: Key creation timestamp
            webUrl:
              type: string
              format: uri
              description: URL to manage API keys in the web interface
    KeyRevokeResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - id
            - revoked
          properties:
            id:
              type: string
              description: Key ID
            revoked:
              type: boolean
              const: true
    CapabilitiesCheckRequest:
      type: object
      required:
        - keys
      properties:
        keys:
          type: array
          description: Array of capability keys to validate
          items:
            type: string
          maxItems: 100
    CapabilityCheckResult:
      type: object
      required:
        - key
        - valid
      properties:
        key:
          type: string
          description: Truncated key (first 8 chars + "...")
        valid:
          type: boolean
          description: Whether the key is valid
        permission:
          type: string
          enum:
            - read
            - append
            - write
          description: Permission level (only present if valid)
        scope:
          type: string
          enum:
            - file
            - folder
            - workspace
          description: Scope type (only present if valid)
        scopeId:
          type: string
          description: Workspace, folder, or file ID (only present if valid)
        error:
          type: string
          description: Error code (NOT_FOUND, EXPIRED, REVOKED) - only present if invalid
    CapabilitiesCheckResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - results
          properties:
            results:
              type: array
              items:
                $ref: '#/components/schemas/CapabilityCheckResult'
    Workspace:
      type: object
      description: Workspace summary for user
      required:
        - id
        - name
      properties:
        id:
          type: string
          description: Workspace ID
        name:
          type: string
          description: Workspace name
    MeResponse:
      type: object
      description: Current authenticated user information
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - id
            - email
            - workspaces
          properties:
            id:
              type: string
              description: User ID
            email:
              type: string
              format: email
              description: User email address
            name:
              type: string
              description: User display name (from OAuth provider)
            image:
              type: string
              format: uri
              description: User avatar URL (from OAuth provider)
            workspaces:
              type: array
              items:
                $ref: '#/components/schemas/Workspace'
              description: Workspaces the user has access to
            createdAt:
              type: string
              format: date-time
              description: Account creation timestamp
            webUrl:
              type: string
              format: uri
              description: URL to access the user's control panel
    LogoutResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          properties:
            status:
              type: string
              const: logged_out
    ClaimWorkspaceResponse:
      type: object
      description: Response from claim workspace endpoint (always instant with OAuth)
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - workspaceId
            - message
            - claimed
          properties:
            workspaceId:
              type: string
              description: Workspace identifier
              pattern: ^ws_[A-Za-z0-9]{12,}$
            claimed:
              type: boolean
              description: Whether the workspace was successfully claimed
              const: true
            message:
              type: string
              description: Status message
              example: claimed
            webUrl:
              type: string
              format: uri
              description: URL to access the workspace control panel
    WorkspaceRenameRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: New workspace name
          minLength: 1
          maxLength: 255
          pattern: .*\S.*
    WorkspaceRenameResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - workspaceId
            - name
            - updatedAt
          properties:
            workspaceId:
              type: string
              description: Workspace ID
              example: ws_x8k2mP9qL3nR
            name:
              type: string
              description: Updated workspace name
              example: Product Operations
            updatedAt:
              type: string
              format: date-time
              description: Time when the workspace name was updated
    SuccessResponse:
      type: object
      required:
        - ok
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          description: Optional success data
          properties:
            message:
              type: string
              description: Success message
    RotateAllResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - workspaceId
            - message
            - rotatedCount
            - keys
            - urls
            - keyCustodyWarning
          properties:
            workspaceId:
              type: string
              description: Workspace ID
              example: ws_x8k2mP9qL3nR
            message:
              type: string
              example: All capability URLs rotated successfully
            rotatedCount:
              type: integer
              description: Number of files/folders that had URLs rotated
              example: 42
            keys:
              $ref: '#/components/schemas/BootstrapKeys'
            urls:
              $ref: '#/components/schemas/BootstrapUrls'
            keyCustodyWarning:
              type: string
              description: Warning that newly generated keys are shown once and must be stored now
              example: Store these keys now. They are shown once and cannot be retrieved again.
    ApiKey:
      type: object
      description: API key metadata (returned in list operations)
      required:
        - id
        - name
        - permissions
        - createdAt
        - prefix
      properties:
        id:
          type: string
          description: Unique key identifier
        name:
          type: string
          description: Human-readable key name
        permissions:
          type: array
          description: Key permission scopes
          items:
            type: string
            enum:
              - read
              - append
              - write
              - export
        createdAt:
          type: string
          format: date-time
          description: Key creation timestamp
        expiresAt:
          type: string
          format: date-time
          description: Key expiration timestamp (optional)
        lastUsedAt:
          type: string
          format: date-time
          description: Last usage timestamp (optional)
        prefix:
          type: string
          description: Key prefix for identification (sk_live_ or sk_test_)
          pattern: ^sk_(live|test)_[A-Za-z0-9]{4}\.\.\.$
          example: sk_live_x8k2...
    ApiKeyListResponse:
      type: object
      description: Response containing list of API keys
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - keys
          properties:
            keys:
              type: array
              description: List of API keys (without full key values)
              items:
                $ref: '#/components/schemas/ApiKey'
            webUrl:
              type: string
              format: uri
              description: URL to manage API keys in the web app
    ApiKeyCreateRequest:
      type: object
      description: Request to create a new API key
      required:
        - name
        - permissions
      properties:
        name:
          type: string
          description: Human-readable name for the key
          maxLength: 64
        permissions:
          type: array
          description: Permission scopes for the key
          minItems: 1
          items:
            type: string
            enum:
              - read
              - append
              - write
              - export
        expiresInSeconds:
          type: integer
          description: Time until expiration in seconds (optional)
          minimum: 3600
    ApiKeyCreateResponse:
      type: object
      description: Response from API key creation (key shown only once)
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - id
            - key
            - name
            - permissions
            - createdAt
          properties:
            id:
              type: string
              description: Unique key identifier
            key:
              type: string
              description: Full API key (shown only once, store securely)
              pattern: ^sk_(live|test)_[A-Za-z0-9]{20,}$
              example: sk_live_demoKey123
            name:
              type: string
              description: Key name
            permissions:
              type: array
              items:
                type: string
                enum:
                  - read
                  - append
                  - write
                  - export
            createdAt:
              type: string
              format: date-time
              description: Key creation timestamp
            expiresAt:
              type: string
              format: date-time
              description: Key expiration timestamp (optional)
            webUrl:
              type: string
              format: uri
              description: URL to manage API keys in the web app
    ApiKeyRevokeResponse:
      type: object
      description: Response from API key revocation
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - id
            - revoked
          properties:
            id:
              type: string
              description: Key identifier
            revoked:
              type: boolean
              const: true
    WebhookLogStatus:
      type: string
      description: Delivery status
      enum:
        - ok
        - failed
        - timeout
        - error
    WebhookLogEntry:
      type: object
      description: Single webhook delivery log entry
      required:
        - id
        - event
        - status
        - timestamp
      properties:
        id:
          type: string
          description: Log entry ID
        event:
          $ref: '#/components/schemas/WebhookEvent'
        status:
          $ref: '#/components/schemas/WebhookLogStatus'
        responseCode:
          type: integer
          description: HTTP response code from webhook endpoint
        timestamp:
          type: string
          format: date-time
          description: Delivery attempt timestamp
        durationMs:
          type: integer
          description: Request duration in milliseconds
        error:
          type: string
          description: Error message if delivery failed
    WebhookLogsResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - logs
          properties:
            logs:
              type: array
              items:
                $ref: '#/components/schemas/WebhookLogEntry'
            pagination:
              $ref: '#/components/schemas/PaginatedResponse'
    WebhookTestRequest:
      type: object
      description: Request to send a test webhook
      properties:
        event:
          $ref: '#/components/schemas/WebhookEvent'
          description: Event type to simulate (defaults to 'append')
    WebhookTestResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - delivered
            - durationMs
          properties:
            delivered:
              type: boolean
              description: Whether test was successfully delivered
            responseCode:
              type: integer
              description: HTTP response code from webhook endpoint
            durationMs:
              type: integer
              description: Request duration in milliseconds
            error:
              type: string
              description: Error message if delivery failed
    SearchResultType:
      type: string
      description: Type of search result
      enum:
        - file
        - append
        - task
    SearchHighlight:
      type: object
      description: Highlighted match position in content
      required:
        - start
        - end
      properties:
        start:
          type: integer
          description: Start position of highlight (0-indexed)
        end:
          type: integer
          description: End position of highlight (0-indexed, exclusive)
    SearchResult:
      type: object
      description: Single search result item
      required:
        - type
        - id
        - content
        - highlights
        - score
      properties:
        type:
          $ref: '#/components/schemas/SearchResultType'
        id:
          type: string
          description: Unique identifier for the result (file ID or append ID)
        file:
          $ref: '#/components/schemas/FileReference'
        content:
          type: string
          description: Content snippet matching the search query
        highlights:
          type: array
          description: Array of highlighted match positions
          items:
            $ref: '#/components/schemas/SearchHighlight'
        score:
          type: number
          format: float
          description: Relevance score for the result
          minimum: 0
          maximum: 1
        status:
          type: string
          description: Status (for task/claim types)
        author:
          type: string
          description: Author of the append
        createdAt:
          type: string
          format: date-time
          description: Creation timestamp
        frontmatter:
          type: object
          additionalProperties: true
          description: Frontmatter fields (when filtering by frontmatter)
    SearchResponse:
      type: object
      description: Response from workspace/scoped search endpoints
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - results
          properties:
            results:
              type: array
              description: Array of search results
              items:
                $ref: '#/components/schemas/SearchResult'
            total:
              type: integer
              description: Total number of matching results
              minimum: 0
        pagination:
          $ref: '#/components/schemas/PaginatedResponse'
    HeartbeatStatus:
      type: string
      description: Agent liveness status
      enum:
        - alive
        - idle
        - busy
        - error
        - stale
    HeartbeatRequest:
      type: object
      description: Request to send agent heartbeat
      required:
        - author
        - status
      properties:
        author:
          type: string
          description: Agent identifier
          pattern: ^[a-zA-Z0-9_-]{1,64}$
        status:
          $ref: '#/components/schemas/HeartbeatStatus'
        currentTask:
          type: string
          description: Currently active task reference (optional)
          pattern: ^[a-zA-Z0-9_-]{1,64}$
        metadata:
          type: object
          additionalProperties: true
          description: Additional agent metadata (optional)
    HeartbeatResponse:
      type: object
      description: Response from heartbeat endpoint
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - id
            - author
            - ts
            - expiresAt
            - nextHeartbeatBy
          properties:
            id:
              type: string
              description: Heartbeat ID
            author:
              type: string
              description: Agent identifier
              pattern: ^[a-zA-Z0-9_-]{1,64}$
            ts:
              type: string
              format: date-time
              description: Heartbeat timestamp
            expiresAt:
              type: string
              format: date-time
              description: When this heartbeat expires
            nextHeartbeatBy:
              type: string
              format: date-time
              description: Deadline for next heartbeat to maintain liveness
    StatsScope:
      type: object
      required:
        - type
        - id
      properties:
        type:
          type: string
          enum:
            - file
            - folder
            - workspace
          description: The scope type of the write key
        id:
          type: string
          description: ID of the scoped resource (file ID, folder path, or workspace ID)
    StatsCounts:
      type: object
      required:
        - files
        - appends
        - tasks
        - claims
        - agents
      properties:
        files:
          type: integer
          description: Number of files in scope
        appends:
          type: integer
          description: Total number of appends
        tasks:
          type: integer
          description: Number of task appends
        claims:
          type: integer
          description: Number of claim appends
        agents:
          type: integer
          description: Number of unique agents/authors
    StatsActivity:
      type: object
      required:
        - lastAppendAt
        - appendsToday
        - appendsThisWeek
      properties:
        lastAppendAt:
          type:
            - string
            - 'null'
          format: date-time
          description: Timestamp of the most recent append
        appendsToday:
          type: integer
          description: Number of appends today
        appendsThisWeek:
          type: integer
          description: Number of appends in the last 7 days
    StatsViaWriteKeyResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - scope
            - counts
            - activity
          properties:
            scope:
              $ref: '#/components/schemas/StatsScope'
            counts:
              $ref: '#/components/schemas/StatsCounts'
            activity:
              $ref: '#/components/schemas/StatsActivity'
    StatsErrorResponse:
      type: object
      properties:
        ok:
          type: boolean
          const: false
        error:
          type: object
          properties:
            code:
              type: string
              enum:
                - INVALID_KEY
                - KEY_EXPIRED
                - KEY_REVOKED
                - PERMISSION_DENIED
    FileStatsResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - appendCount
            - taskStats
          properties:
            appendCount:
              type: integer
              description: Total number of appends on this file
            taskStats:
              $ref: '#/components/schemas/TaskStats'
    WorkspaceStatsResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - fileCount
            - folderCount
            - totalSize
            - appendCount
            - taskStats
            - storageUsed
            - storageLimit
          properties:
            fileCount:
              type: integer
              description: Total number of files in workspace
            folderCount:
              type: integer
              description: Total number of folders in workspace
            totalSize:
              type: integer
              description: Total size of all files in bytes
            appendCount:
              type: integer
              description: Total number of appends across all files
            taskStats:
              $ref: '#/components/schemas/TaskStats'
            storageUsed:
              type: integer
              description: Storage used in bytes
            storageLimit:
              type: integer
              description: Storage limit in bytes
    JobStatus:
      type: string
      description: Status of an async job
      enum:
        - pending
        - processing
        - completed
        - failed
    JobResponse:
      type: object
      description: Response containing job status and details
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - id
            - status
            - createdAt
          properties:
            id:
              type: string
              description: Unique job identifier
              example: job_xyz
            status:
              $ref: '#/components/schemas/JobStatus'
            progress:
              type: object
              description: Progress information (for processing jobs)
              properties:
                current:
                  type: integer
                  description: Items processed so far
                total:
                  type: integer
                  description: Total items to process
                message:
                  type: string
                  description: Human-readable progress message
            result:
              type: object
              additionalProperties: true
              description: Job result data (for completed jobs)
            error:
              type: object
              description: Error details (for failed jobs)
              properties:
                code:
                  type: string
                message:
                  type: string
            createdAt:
              type: string
              format: date-time
              description: Job creation timestamp
            completedAt:
              type: string
              format: date-time
              description: Job completion timestamp (optional)
    ExportJobCreateResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - jobId
            - status
            - statusUrl
          properties:
            jobId:
              type: string
              description: Export job identifier
            status:
              type: string
              enum:
                - queued
                - processing
            statusUrl:
              type: string
              description: URL to poll for job status
            estimatedSize:
              type: string
              description: Estimated export size
            position:
              type: integer
              description: Position in queue (if queued)
    ExportJobStatusResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - id
            - status
          properties:
            id:
              type: string
              description: Export job identifier
            status:
              type: string
              enum:
                - queued
                - processing
                - ready
                - failed
                - expired
            progress:
              type: object
              properties:
                filesProcessed:
                  type: integer
                totalFiles:
                  type: integer
                bytesWritten:
                  type: string
            startedAt:
              type: string
              format: date-time
            downloadUrl:
              type: string
              description: URL to download export (only when status is ready)
            expiresAt:
              type: string
              format: date-time
              description: When the download URL expires
            checksum:
              type: string
              description: SHA-256 checksum (only when status is ready)
            size:
              type: string
              description: Final export size (only when status is ready)
            error:
              type: object
              description: Error details (only when status is failed)
              properties:
                code:
                  type: string
                message:
                  type: string
    DeletedFileEntry:
      type: object
      required:
        - id
        - path
        - deletedAt
        - expiresAt
      properties:
        id:
          type: string
          description: File identifier
        path:
          type: string
          description: Original file path
        deletedAt:
          type: string
          format: date-time
          description: When the file was deleted
        expiresAt:
          type: string
          format: date-time
          description: When the file becomes unrecoverable
        deletedBy:
          type: string
          description: Author who deleted the file (if known)
        size:
          type: integer
          description: File size in bytes
    DeletedFilesListResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - files
          properties:
            files:
              type: array
              items:
                $ref: '#/components/schemas/DeletedFileEntry'
        pagination:
          type: object
          properties:
            cursor:
              type: string
            hasMore:
              type: boolean
            total:
              type: integer
    AgentLiveness:
      type: object
      description: Current liveness state of an agent
      required:
        - author
        - status
        - lastSeen
      properties:
        author:
          type: string
          description: Agent identifier
          pattern: ^[a-zA-Z0-9_-]{1,64}$
        status:
          $ref: '#/components/schemas/HeartbeatStatus'
        lastSeen:
          type: string
          format: date-time
          description: Last heartbeat timestamp
        stale:
          type: boolean
          description: Whether agent is considered stale
        currentTask:
          type: string
          description: Currently active task reference (optional)
          pattern: ^[a-zA-Z0-9_-]{1,64}$
        metadata:
          type: object
          additionalProperties: true
          description: Additional agent metadata (optional)
    AgentLivenessResponse:
      type: object
      description: Response containing agent liveness information
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - agents
            - staleThresholdSeconds
          properties:
            agents:
              type: array
              description: List of agents with their liveness status
              items:
                $ref: '#/components/schemas/AgentLiveness'
            staleThresholdSeconds:
              type: integer
              description: Seconds after which an agent is considered stale
              example: 30
            webUrl:
              type: string
              format: uri
              description: URL to view agents in the web interface
    OrchestrationSummary:
      type: object
      required:
        - pending
        - claimed
        - completed
        - stalled
        - cancelled
      properties:
        pending:
          type: integer
        claimed:
          type: integer
        completed:
          type: integer
        stalled:
          type: integer
        cancelled:
          type: integer
    OrchestrationTask:
      type: object
      required:
        - id
        - file
        - content
        - author
        - status
        - createdAt
      properties:
        id:
          type: string
          description: Task append ID
        file:
          type: object
          required:
            - id
            - path
          properties:
            id:
              type: string
            path:
              type: string
        content:
          type: string
          description: Task content/description
        author:
          type: string
          description: Task creator
        status:
          type: string
          enum:
            - pending
            - claimed
            - stalled
            - completed
            - cancelled
          description: Current orchestration status for this task
        priority:
          type: string
          enum:
            - low
            - medium
            - high
            - critical
        labels:
          type: array
          items:
            type: string
        createdAt:
          type: string
          format: date-time
        due:
          type: string
          format: date-time
        claim:
          type: object
          description: Current claim info (if claimed)
          properties:
            id:
              type: string
            author:
              type: string
            expiresAt:
              type: string
              format: date-time
            blocked:
              type: boolean
            blockReason:
              type: string
    OrchestrationClaim:
      type: object
      required:
        - id
        - taskId
        - file
        - author
        - expiresAt
        - status
      properties:
        id:
          type: string
          description: Claim append ID
        taskId:
          type: string
          description: Task being claimed
        file:
          type: object
          required:
            - id
            - path
          properties:
            id:
              type: string
            path:
              type: string
        author:
          type: string
          description: Claiming agent
        expiresAt:
          type: string
          format: date-time
        expiresInSeconds:
          type: integer
        status:
          type: string
          enum:
            - active
            - blocked
            - expired
        blocked:
          type: boolean
        blockReason:
          type: string
    OrchestrationAgentStatus:
      type: object
      properties:
        author:
          type: string
        status:
          type: string
          enum:
            - alive
            - idle
            - busy
            - stale
        lastSeen:
          type: string
          format: date-time
        currentTask:
          type: string
    OrchestrationWorkload:
      type: object
      properties:
        activeClaims:
          type: integer
        completedToday:
          type: integer
    OrchestrationReadOnlyResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - summary
            - tasks
            - claims
            - agents
            - workload
          properties:
            summary:
              $ref: '#/components/schemas/OrchestrationSummary'
            tasks:
              type: array
              description: Flat orchestration tasks list; group by task.status in consumers
              items:
                $ref: '#/components/schemas/OrchestrationTask'
            claims:
              type: array
              description: Active claims across all files
              items:
                $ref: '#/components/schemas/OrchestrationClaim'
            agents:
              type: array
              description: Agent liveness status
              items:
                $ref: '#/components/schemas/OrchestrationAgentStatus'
            workload:
              type: object
              description: Workload distribution across agents
              additionalProperties:
                $ref: '#/components/schemas/OrchestrationWorkload'
            pagination:
              type: object
              properties:
                cursor:
                  type: string
                hasMore:
                  type: boolean
            webUrl:
              type: string
              format: uri
              description: URL to view orchestration in the web interface
    OrchestrationAdminResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - summary
            - tasks
            - claims
            - agents
            - workload
          properties:
            summary:
              $ref: '#/components/schemas/OrchestrationSummary'
            tasks:
              type: array
              description: Flat orchestration tasks list; group by task.status in consumers
              items:
                $ref: '#/components/schemas/OrchestrationTask'
            claims:
              type: array
              description: Active claims with write-level actions
              items:
                allOf:
                  - $ref: '#/components/schemas/OrchestrationClaim'
                  - type: object
                    properties:
                      canForceExpire:
                        type: boolean
                        description: Whether this claim can be force-expired
                        const: true
            agents:
              type: array
              items:
                $ref: '#/components/schemas/OrchestrationAgentStatus'
            workload:
              type: object
              additionalProperties:
                $ref: '#/components/schemas/OrchestrationWorkload'
            pagination:
              type: object
              properties:
                cursor:
                  type: string
                hasMore:
                  type: boolean
            webUrl:
              type: string
              format: uri
              description: URL to view orchestration in the web interface
    RenewClaimRequest:
      type: object
      properties:
        expiresInSeconds:
          type: integer
          description: New TTL in seconds (default 300)
          default: 300
          minimum: 60
          maximum: 86400
    ControlClaim:
      type: object
      description: Claim data formatted for control view display
      required:
        - id
        - taskId
        - path
        - author
        - status
        - expiresAt
      properties:
        id:
          type: string
          description: Claim append ID
        taskId:
          type: string
          description: The task being claimed
        taskTitle:
          type: string
          description: Task title/content preview for display
        path:
          type: string
          description: File path where the task lives
        appendKey:
          type: string
          description: Append capability key for the file (for direct append access)
        author:
          type: string
          description: Claiming agent/user
        status:
          type: string
          enum:
            - active
            - expired
            - completed
            - cancelled
            - blocked
          description: Current claim status
        claimedAt:
          type: string
          format: date-time
          description: When the claim was created
        expiresAt:
          type: string
          format: date-time
          description: When the claim expires
        expiresInSeconds:
          type: integer
          description: Seconds until expiry (convenience field)
        completedAt:
          type: string
          format: date-time
          description: When the task was completed (if completed)
        blockedReason:
          type: string
          description: Why the claim is blocked (if blocked)
    ClaimMutationResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - claim
          properties:
            claim:
              $ref: '#/components/schemas/ControlClaim'
            appendId:
              type: string
              description: ID of the append created by this mutation
            webUrl:
              type: string
              format: uri
              description: URL to view claims in the web interface
    CompleteClaimRequest:
      type: object
      properties:
        content:
          type: string
          description: Completion message/content
    CancelClaimRequest:
      type: object
      properties:
        reason:
          type: string
          description: Why the claim is being cancelled
    BlockClaimRequest:
      type: object
      required:
        - reason
      properties:
        reason:
          type: string
          description: Why the claim is blocked
          minLength: 1
          maxLength: 500
    FileCreateResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - id
            - path
            - urls
            - createdAt
          properties:
            id:
              type: string
              description: File ID
            path:
              type: string
              description: Full file path
            urls:
              $ref: '#/components/schemas/CapabilityUrls'
            createdAt:
              type: string
              format: date-time
              description: Creation timestamp
            webUrl:
              type: string
              format: uri
              description: URL to view this file in the web app
    HealthCheckSimpleResponse:
      type: object
      description: Simple health check response for liveness probes
      required:
        - ok
        - status
      properties:
        ok:
          type: boolean
          const: true
        status:
          type: string
          enum:
            - healthy
          description: Always "healthy" when responding
        timestamp:
          type: string
          format: date-time
          description: Current server time
        uptimeSeconds:
          type: integer
          description: Server uptime in seconds
        version:
          type: string
          description: API version
          example: 0.1.0
    ChangeType:
      type: string
      description: Type of changelog entry
      enum:
        - added
        - changed
        - deprecated
        - removed
        - fixed
        - security
    ChangelogEntry:
      type: object
      description: Single changelog entry
      required:
        - version
        - date
        - changes
      properties:
        version:
          type: string
          description: Version number
          example: 1.2.0
        date:
          type: string
          format: date
          description: Release date
          example: '2024-01-15'
        changes:
          type: array
          description: List of changes in this version
          items:
            type: object
            required:
              - type
              - description
            properties:
              type:
                $ref: '#/components/schemas/ChangeType'
              description:
                type: string
                description: Change description
    ChangelogResponse:
      type: object
      description: Response containing changelog entries
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - currentVersion
            - releasedAt
            - entries
          properties:
            currentVersion:
              type: string
              description: Current API version
              example: 1.5.2
            releasedAt:
              type: string
              format: date-time
              description: Release date of current version
              example: '2025-12-15T00:00:00Z'
            entries:
              type: array
              description: List of changelog entries (newest first)
              items:
                $ref: '#/components/schemas/ChangelogEntry'
    RegionStatus:
      type: object
      description: Status of a deployment region
      required:
        - name
        - status
      properties:
        name:
          type: string
          description: Region name
          example: us-east-1
        status:
          type: string
          enum:
            - operational
            - degraded
            - down
          description: Region status
    StatusResponse:
      type: object
      description: Response from status endpoint with system information
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - status
            - timestamp
            - environment
            - uptimeSeconds
            - version
            - database
            - storage
            - websocket
            - regions
          properties:
            status:
              type: string
              enum:
                - operational
                - degraded
                - partial_outage
                - major_outage
              description: Overall service status
            timestamp:
              type: string
              format: date-time
              description: Current server time in ISO-8601 format
            environment:
              type: string
              enum:
                - development
                - test
                - production
              description: Runtime environment
            uptimeSeconds:
              type: integer
              description: Server uptime in seconds
            version:
              type: string
              description: API version
              example: 0.1.0
            database:
              type: object
              description: Database status
              required:
                - status
              properties:
                status:
                  type: string
                  enum:
                    - operational
                    - degraded
                    - down
                  description: Database status
                latencyMs:
                  type: number
                  description: Database latency in milliseconds
            storage:
              type: object
              description: Storage status
              required:
                - status
              properties:
                status:
                  type: string
                  enum:
                    - operational
                    - degraded
                    - down
                  description: Storage service status
                latencyMs:
                  type: number
                  description: Storage check latency in milliseconds
            websocket:
              type: object
              description: WebSocket subsystem status
              required:
                - status
              properties:
                status:
                  type: string
                  enum:
                    - operational
                    - degraded
                    - down
                  description: WebSocket service status
                latencyMs:
                  type: number
                  description: WebSocket check latency in milliseconds
                activeConnections:
                  type: integer
                  minimum: 0
                  description: Number of active WebSocket connections
            regions:
              type: array
              description: Available regions and their status
              items:
                $ref: '#/components/schemas/RegionStatus'
    CapabilityCheckInWorkspaceResult:
      type: object
      required:
        - key
        - valid
      properties:
        key:
          type: string
          description: Truncated key (first 8 chars + "...")
        valid:
          type: boolean
          description: Whether the key is valid
        permission:
          type: string
          enum:
            - read
            - append
            - write
          description: Permission level (only present if valid)
        scope:
          type: string
          enum:
            - file
            - folder
            - workspace
          description: Scope type (only present if valid)
        scopeId:
          type: string
          description: Workspace, folder, or file ID (only present if valid)
        path:
          type: string
          description: Resource path (only present if valid and belongs to workspace)
        status:
          type: string
          enum:
            - active
            - expired
            - revoked
          description: Key status (only present if valid and belongs to workspace)
        error:
          type: string
          description: Error code (NOT_FOUND, EXPIRED, REVOKED) - only present if invalid
    CapabilitiesCheckInWorkspaceResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - results
          properties:
            results:
              type: array
              items:
                $ref: '#/components/schemas/CapabilityCheckInWorkspaceResult'
    AuditLogEntry:
      type: object
      required:
        - id
        - action
        - resourceType
        - createdAt
      properties:
        id:
          type: string
          description: Unique audit log ID
        action:
          type: string
          description: The action that was performed
        resourceType:
          type: string
          description: Type of resource affected
        resourceId:
          type: string
          description: ID of the affected resource
        resourcePath:
          type: string
          description: Path of the affected resource
        actor:
          type: string
          description: Actor who performed the action
        actorType:
          type: string
          enum:
            - capability_url
            - api_key
            - session
          description: Type of actor
        metadata:
          type: object
          description: Additional action-specific metadata
          additionalProperties: true
        ipAddress:
          type: string
          description: IP address of the request
        userAgent:
          type: string
          description: User agent of the request
        createdAt:
          type: string
          format: date-time
          description: When the action occurred
    AuditLogPagination:
      type: object
      required:
        - total
        - limit
        - cursor
        - hasMore
      properties:
        total:
          type: integer
          description: Total number of matching logs
        limit:
          type: integer
          description: Maximum logs per page
        cursor:
          type:
            - string
            - 'null'
          description: Cursor for next page (opaque), null when no more results
        hasMore:
          type: boolean
          description: Whether more results are available
    AuditLogsResponse:
      type: object
      required:
        - ok
        - data
        - pagination
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: array
          items:
            $ref: '#/components/schemas/AuditLogEntry'
        pagination:
          $ref: '#/components/schemas/AuditLogPagination'
    AdminMetricsResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          enum:
            - true
        data:
          type: object
          required:
            - storage
            - counts
            - quotas
            - uptime
          properties:
            storage:
              type: object
              required:
                - databaseSizeBytes
                - databaseSizeMB
                - usagePercent
              properties:
                databaseSizeBytes:
                  type: integer
                  description: Current database file size in bytes
                databaseSizeMB:
                  type: number
                  format: float
                  description: Current database file size in megabytes
                maxSizeBytes:
                  type: integer
                  description: Maximum allowed database size (from config or volume)
                maxSizeMB:
                  type: number
                  format: float
                  description: Maximum allowed database size in megabytes
                usagePercent:
                  type: number
                  format: float
                  description: Percentage of storage used (0-100)
            counts:
              type: object
              required:
                - workspaces
                - files
                - folders
                - users
                - activeSessions
                - capabilityKeys
              properties:
                workspaces:
                  type: integer
                  description: Total number of workspaces (excluding deleted)
                files:
                  type: integer
                  description: Total number of files (excluding deleted)
                folders:
                  type: integer
                  description: Total number of folders (excluding deleted)
                users:
                  type: integer
                  description: Total number of registered users
                activeSessions:
                  type: integer
                  description: Number of active user sessions
                capabilityKeys:
                  type: integer
                  description: Total number of capability keys (excluding revoked)
            quotas:
              type: object
              required:
                - maxWorkspaceStorageBytes
                - maxFileSizeBytes
              properties:
                maxWorkspaceStorageBytes:
                  type: integer
                  description: Maximum storage per workspace in bytes
                maxFileSizeBytes:
                  type: integer
                  description: Maximum file size in bytes
            uptime:
              type: object
              required:
                - seconds
                - formatted
              properties:
                seconds:
                  type: integer
                  description: Server uptime in seconds
                formatted:
                  type: string
                  description: Human-readable uptime (e.g., "1d 2h 30m")
    FolderUrls:
      type: object
      required:
        - path
        - urls
      properties:
        path:
          type: string
          description: Folder path
        urls:
          $ref: '#/components/schemas/CapabilityUrls'
    User:
      type: object
      description: User information
      required:
        - id
        - email
      properties:
        id:
          type: string
          description: User ID
        email:
          type: string
          format: email
          description: User email address
        createdAt:
          type: string
          format: date-time
          description: Account creation timestamp
    ClaimWorkspaceRequest:
      type: object
      description: Request to claim a workspace (OAuth session provides identity)
      properties: {}
      additionalProperties: false
    SubscribeMessageType:
      type: string
      description: Type of WebSocket message type
      enum:
        - connected
        - error
    SubscribeMessage:
      type: object
      description: WebSocket control message
      required:
        - type
        - data
      properties:
        type:
          $ref: '#/components/schemas/SubscribeMessageType'
        data:
          type: object
          additionalProperties: true
          description: Control message payload (structure varies by type)
    HealthStatus:
      type: string
      description: Overall system health status
      enum:
        - healthy
        - degraded
        - unhealthy
    HealthResponse:
      type: object
      description: Response from health check endpoint
      required:
        - ok
        - status
        - version
        - checks
      properties:
        ok:
          type: boolean
          const: true
        status:
          $ref: '#/components/schemas/HealthStatus'
        version:
          type: string
          description: API version
          example: 1.0.0
        checks:
          type: object
          description: Individual health check results
          additionalProperties:
            type: object
            properties:
              status:
                $ref: '#/components/schemas/HealthStatus'
              latencyMs:
                type: integer
                description: Check latency in milliseconds
              message:
                type: string
                description: Additional status message
    TransferWorkspaceRequest:
      type: object
      required:
        - newOwnerEmail
      properties:
        newOwnerEmail:
          type: string
          format: email
          description: Email of the new owner (must have an OAuth account)
          example: new-owner@example.com
    FolderClaimEntry:
      type: object
      required:
        - id
        - fileId
        - path
        - taskId
        - expiresAt
        - status
        - author
      properties:
        id:
          type: string
        fileId:
          type: string
        path:
          type: string
        taskId:
          type: string
        taskContent:
          type: string
        author:
          type: string
          description: Author who made the claim
        expiresAt:
          type: string
          format: date-time
        expiresInSeconds:
          type: integer
        status:
          type: string
          enum:
            - active
            - blocked
            - expired
        blockedAt:
          type: string
          format: date-time
        blockReason:
          type: string
    FolderClaimsViaAppendKeyResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - claims
            - count
          properties:
            claims:
              type: array
              items:
                $ref: '#/components/schemas/FolderClaimEntry'
            count:
              type: integer
            webUrl:
              type: string
              format: uri
              description: URL to view claims in the web interface
    ListWorkspaceClaimsResponse:
      type: object
      required:
        - ok
        - data
      properties:
        ok:
          type: boolean
          const: true
        data:
          type: object
          required:
            - claims
          properties:
            claims:
              type: array
              items:
                $ref: '#/components/schemas/ControlClaim'
            webUrl:
              type: string
              format: uri
              description: URL to view claims in the web interface
  parameters:
    capabilityKey:
      name: key
      in: path
      required: true
      description: Capability key (20+ chars, base62 with underscore)
      schema:
        type: string
        pattern: ^[A-Za-z0-9_]{20,}$
        minLength: 20
    format:
      name: format
      in: query
      description: Response format
      schema:
        type: string
        enum:
          - raw
          - parsed
          - structure
    since:
      name: since
      in: query
      description: Return items modified after this timestamp (ISO 8601)
      schema:
        type: string
        format: date-time
    appendId:
      name: appendId
      in: path
      required: true
      description: Append identifier (e.g., a1, a42)
      schema:
        type: string
        pattern: ^a[0-9]+$
    folderPath:
      name: path
      in: path
      required: true
      description: URL-encoded folder path
      schema:
        type: string
    limit:
      name: limit
      in: query
      description: Maximum number of items to return
      schema:
        type: integer
        default: 50
        minimum: 1
        maximum: 1000
    cursor:
      name: cursor
      in: query
      description: Pagination cursor for fetching next page
      schema:
        type: string
    folderPathQuery:
      name: path
      in: query
      required: false
      description: URL-encoded folder path (omit for workspace root)
      schema:
        type: string
    author:
      name: author
      in: query
      description: Filter by author identifier
      schema:
        type: string
    keyId:
      name: keyId
      in: path
      required: true
      description: Scoped key identifier
      schema:
        type: string
    workspaceId:
      name: workspaceId
      in: path
      required: true
      description: Workspace identifier
      schema:
        type: string
        pattern: ^ws_[A-Za-z0-9]{12,}$
    webhookId:
      name: webhookId
      in: path
      required: true
      description: Webhook identifier
      schema:
        type: string
    jobId:
      name: jobId
      in: path
      required: true
      description: Background job identifier
      schema:
        type: string
    claimId:
      name: claimId
      in: path
      required: true
      description: The claim's append ID
      schema:
        type: string
      example: a_x8k2mP9qL3nR7mQ2pN4x
  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            ok: false
            error:
              code: INVALID_REQUEST
              message: Request validation failed
              details:
                field: content
                reason: Content exceeds maximum length
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            ok: false
            error:
              code: FILE_NOT_FOUND
              message: File not found
    Gone:
      description: Resource deleted (recoverable)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            ok: false
            error:
              code: FILE_DELETED
              message: File is soft-deleted
              details:
                recoverable: true
                expiresAt: '2024-01-15T11:00:00Z'
    RateLimited:
      description: Rate limit exceeded
      headers:
        Retry-After:
          description: Seconds to wait before retrying
          schema:
            type: integer
        X-RateLimit-Limit:
          description: Request limit per window
          schema:
            type: integer
        X-RateLimit-Remaining:
          description: Remaining requests in current window
          schema:
            type: integer
        X-RateLimit-Reset:
          description: Unix timestamp when limit resets
          schema:
            type: integer
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            ok: false
            error:
              code: RATE_LIMITED
              message: Too many requests
              details:
                retryAfterSeconds: 60
    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            ok: false
            error:
              code: UNAUTHORIZED
              message: Authentication required
    Conflict:
      description: Conflict (e.g., concurrent edit, already claimed)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            ok: false
            error:
              code: CONFLICT
              message: File was modified since last read
              details:
                currentEtag: x9y0z1a2
                providedEtag: a1b2c3d4
    Forbidden:
      description: Permission denied
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            ok: false
            error:
              code: PERMISSION_DENIED
              message: You do not have permission to access this resource
    ServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            ok: false
            error:
              code: SERVER_ERROR
              message: Internal server error
    PayloadTooLarge:
      description: Request payload exceeds size limit
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            ok: false
            error:
              code: PAYLOAD_TOO_LARGE
              message: Request body exceeds maximum size of 10MB
              details:
                maxSize: 10485760
                receivedSize: 15728640
  securitySchemes:
    capabilityKeyAuth:
      type: apiKey
      in: header
      name: X-Capability-Key
      x-security-type: capability-url
      description: |
        Capability URL authentication (Tier 1). The `key` path parameter contains a
        cryptographic token that grants specific permissions (read, append, or write)
        to a file or folder.

        **Note**: Authentication is via the URL path parameter `{key}`, not a header.
        This security scheme exists for documentation purposes only.

        Key formats:
        - Root capability key: `^[A-Za-z0-9]{22,}$` (e.g., x8k2mP9qL3nR7mQ2pN4xK9)
        - Scoped capability key: `^(r|a|w)_[A-Za-z0-9]{20,}$` (e.g., a_x8k2mP9qL3nR7mQ2pN4x)

        Capability URLs handle 95% of operations including:
        - All read operations
        - All create operations (appends, webhooks, scoped keys)
        - Destructive operations (with "type name to confirm" UI dialogs)
    bearerAuth:
      type: http
      scheme: bearer
      description: |
        API key authentication for programmatic access.

        Key formats:
        - Live mode: `sk_live_[A-Za-z0-9]{20,}` (e.g., sk_live_x8k2mP9qL3nR7mQ2pN4x)
        - Test mode: `sk_test_[A-Za-z0-9]{20,}` (e.g., sk_test_demoKey123)

        Include in Authorization header:
        `Authorization: Bearer sk_live_...`

        API keys can be created with a write capability URL (no OAuth required).
    oauthSession:
      type: apiKey
      in: cookie
      name: better-auth.session_token
      description: |
        OAuth session cookie from GitHub/Google authentication via BetterAuth.

        **Tier 2 operations only** - required for nuclear operations:
        - Rotate ALL capability URLs (would invalidate all access)
        - Delete workspace (permanent, unrecoverable)
        - Transfer ownership (changes who controls the workspace)

        Most operations do NOT require OAuth - use capability URLs instead.
    adminToken:
      type: http
      scheme: bearer
      description: |
        Admin token for operator-only endpoints.

        **Set via ADMIN_SECRET environment variable on the server.**

        Include in Authorization header:
        `Authorization: Bearer <ADMIN_SECRET>`

        Used for:
        - System metrics and health monitoring
        - Storage usage monitoring
        - Entity counts (workspaces, files, users)

        **Security:** Never expose the ADMIN_SECRET in client-side code.
        Only use from secure operator tools or monitoring systems.
