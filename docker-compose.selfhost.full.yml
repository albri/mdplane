name: mdplane-selfhost-full

services:
  server:
    build:
      context: .
      dockerfile: apps/server/Dockerfile
    restart: unless-stopped
    ports:
      - '${API_PORT:-3001}:3001'
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3001
      HOST: 0.0.0.0
      DATABASE_URL: /data/mdplane.sqlite
      BASE_URL: ${BASE_URL:-http://localhost:3001}
      APP_URL: ${APP_URL:-http://localhost:3000}
      WS_URL: ${WS_URL:-ws://localhost:3001/ws}
      BETTER_AUTH_URL: ${BETTER_AUTH_URL:-http://localhost:3001}
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:?BETTER_AUTH_SECRET is required}
      MP_JWT_SECRET: ${MP_JWT_SECRET:?MP_JWT_SECRET is required}
      MDPLANE_GOVERNED_MODE: ${MDPLANE_GOVERNED_MODE:-false}
      DISABLE_BACKGROUND_JOBS: ${DISABLE_BACKGROUND_JOBS:-false}
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID:-}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET:-}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      ADMIN_SECRET: ${ADMIN_SECRET:-}
    volumes:
      - mdplane-data:/data
    networks:
      - mdplane-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://127.0.0.1:3001/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    restart: unless-stopped
    ports:
      - '${APP_PORT:-3000}:3000'
    environment:
      NODE_ENV: production
      API_INTERNAL_URL: ${API_INTERNAL_URL:-http://server:3001}
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:3001}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
      NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL:-ws://localhost:3001/ws}
      NEXT_PUBLIC_GOVERNED_MODE: ${NEXT_PUBLIC_GOVERNED_MODE:-false}
    networks:
      - mdplane-network
    depends_on:
      server:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://127.0.0.1:3000/']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  docs:
    build:
      context: .
      dockerfile: apps/docs/Dockerfile
    restart: unless-stopped
    ports:
      - '${DOCS_PORT:-3002}:3002'
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_DOCS_URL: ${NEXT_PUBLIC_DOCS_URL:-http://localhost:3002}
    networks:
      - mdplane-network
    depends_on:
      web:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://127.0.0.1:3002/']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  landing:
    build:
      context: .
      dockerfile: apps/landing/Dockerfile
    restart: unless-stopped
    ports:
      - '${LANDING_PORT:-3004}:3000'
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_SITE_URL: ${NEXT_PUBLIC_SITE_URL:-http://localhost:3004}
      NEXT_PUBLIC_API_URL: ${LANDING_NEXT_PUBLIC_API_URL:-http://localhost:3001}
    networks:
      - mdplane-network
    depends_on:
      web:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://127.0.0.1:3000/']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

networks:
  mdplane-network:
    driver: bridge

volumes:
  mdplane-data:
    driver: local
